<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>反脆弱 — 交互式学习指南</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@300;400;500;600;700;900&family=Playfair+Display:ital,wght@0,400;0,700;0,900;1,400&family=JetBrains+Mono:wght@300;400;500&family=Source+Serif+4:ital,opsz,wght@0,8..60,300;0,8..60,400;0,8..60,600;0,8..60,700;1,8..60,400&display=swap" rel="stylesheet">
<link rel="stylesheet" href="../../css/shared.css">
<style>
:root {
  --bg-deep: #0a0a08;
  --bg-surface: #121210;
  --bg-elevated: #1a1a16;
  --bg-card: #1e1e19;
  --text-primary: #e8e4d9;
  --text-secondary: #9e9a8f;
  --text-muted: #6b6860;
  --fragile-color: #c94040;
  --fragile-glow: #c9404033;
  --robust-color: #7a7a72;
  --robust-glow: #7a7a7233;
  --antifragile-color: #c9a84c;
  --antifragile-glow: #c9a84c33;
  --accent: #c9a84c;
  --accent-dim: #c9a84c22;
  --border: #2a2a24;
  --border-light: #3a3a32;
  --success: #5a9e6f;
  --error: #c94040;
  --font-display: 'Playfair Display', Georgia, serif;
  --font-body: 'Noto Serif SC', 'Source Serif 4', Georgia, serif;
  --font-mono: 'JetBrains Mono', monospace;
  --ease-out-expo: cubic-bezier(0.16, 1, 0.3, 1);
  --ease-spring: cubic-bezier(0.34, 1.56, 0.64, 1);
}

* { margin: 0; padding: 0; box-sizing: border-box; }

html {
  scroll-behavior: smooth;
  scrollbar-width: thin;
  scrollbar-color: var(--border-light) var(--bg-deep);
}

body {
  background: var(--bg-deep);
  color: var(--text-primary);
  font-family: var(--font-body);
  font-size: 17px;
  line-height: 1.7;
  overflow-x: hidden;
  -webkit-font-smoothing: antialiased;
}

::selection {
  background: var(--accent);
  color: var(--bg-deep);
}

/* NOISE TEXTURE OVERLAY */
body::before {
  content: '';
  position: fixed;
  inset: 0;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.03'/%3E%3C/svg%3E");
  pointer-events: none;
  z-index: 9999;
}

/* NAVIGATION */
nav {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  z-index: 1000;
  background: rgba(10, 10, 8, 0.85);
  backdrop-filter: blur(20px);
  border-bottom: 1px solid var(--border);
  transition: transform 0.4s var(--ease-out-expo);
}

nav.hidden { transform: translateY(-100%); }

.nav-inner {
  max-width: 1400px;
  margin: 0 auto;
  padding: 0 40px;
  height: 60px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.nav-logo {
  font-family: var(--font-display);
  font-size: 18px;
  font-weight: 700;
  letter-spacing: 0.05em;
  color: var(--text-primary);
  cursor: pointer;
}

.nav-logo span { color: var(--accent); }

.nav-tabs {
  display: flex;
  gap: 4px;
}

.nav-tab {
  font-family: var(--font-mono);
  font-size: 11px;
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.12em;
  padding: 8px 16px;
  border: 1px solid transparent;
  border-radius: 4px;
  background: none;
  color: var(--text-muted);
  cursor: pointer;
  transition: all 0.3s ease;
}

.nav-tab:hover { color: var(--text-secondary); border-color: var(--border); }
.nav-tab.active { color: var(--accent); border-color: var(--accent); background: var(--accent-dim); }

.progress-bar {
  position: absolute;
  bottom: 0;
  left: 0;
  height: 2px;
  background: linear-gradient(90deg, var(--accent), var(--antifragile-color));
  transition: width 0.3s ease;
}

/* HERO SECTION */
.hero {
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  text-align: center;
  padding: 120px 40px 80px;
  position: relative;
  overflow: hidden;
}

.hero::before {
  content: '';
  position: absolute;
  top: -200px;
  left: 50%;
  transform: translateX(-50%);
  width: 800px;
  height: 800px;
  background: radial-gradient(circle, var(--antifragile-glow) 0%, transparent 70%);
  pointer-events: none;
}

.hero-subtitle {
  font-family: var(--font-mono);
  font-size: 11px;
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.3em;
  color: var(--accent);
  margin-bottom: 32px;
  opacity: 0;
  animation: fadeUp 0.8s var(--ease-out-expo) 0.2s forwards;
}

.hero-title {
  font-family: var(--font-display);
  font-size: clamp(56px, 8vw, 120px);
  font-weight: 900;
  line-height: 0.95;
  letter-spacing: -0.02em;
  margin-bottom: 24px;
  opacity: 0;
  animation: fadeUp 0.8s var(--ease-out-expo) 0.4s forwards;
}

.hero-title em {
  font-style: italic;
  color: var(--accent);
}

.hero-desc {
  max-width: 600px;
  font-size: 19px;
  color: var(--text-secondary);
  line-height: 1.7;
  margin-bottom: 48px;
  opacity: 0;
  animation: fadeUp 0.8s var(--ease-out-expo) 0.6s forwards;
}

.hero-triad {
  display: flex;
  gap: 48px;
  opacity: 0;
  animation: fadeUp 0.8s var(--ease-out-expo) 0.8s forwards;
}

.triad-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
}

.triad-icon {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 22px;
  margin-bottom: 4px;
  transition: transform 0.3s var(--ease-spring);
}

.triad-icon:hover { transform: scale(1.15); }

.triad-icon.fragile { background: var(--fragile-glow); border: 1px solid var(--fragile-color); }
.triad-icon.robust { background: var(--robust-glow); border: 1px solid var(--robust-color); }
.triad-icon.antifragile { background: var(--antifragile-glow); border: 1px solid var(--antifragile-color); }

.triad-label {
  font-family: var(--font-mono);
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 0.15em;
}

.triad-label.fragile { color: var(--fragile-color); }
.triad-label.robust { color: var(--robust-color); }
.triad-label.antifragile { color: var(--antifragile-color); }

.scroll-hint {
  position: absolute;
  bottom: 40px;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
  opacity: 0;
  animation: fadeUp 0.8s var(--ease-out-expo) 1.2s forwards;
}

.scroll-hint span {
  font-family: var(--font-mono);
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 0.2em;
  color: var(--text-muted);
}

.scroll-line {
  width: 1px;
  height: 40px;
  background: var(--border-light);
  position: relative;
  overflow: hidden;
}

.scroll-line::after {
  content: '';
  position: absolute;
  top: -40px;
  left: 0;
  width: 1px;
  height: 40px;
  background: var(--accent);
  animation: scrollPulse 2s ease infinite;
}

/* SECTIONS */
.section {
  display: none;
  padding: 100px 40px 80px;
  max-width: 1400px;
  margin: 0 auto;
  min-height: 100vh;
}

.section.active { display: block; }

.section-header {
  margin-bottom: 64px;
  padding-bottom: 32px;
  border-bottom: 1px solid var(--border);
}

.section-label {
  font-family: var(--font-mono);
  font-size: 11px;
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.2em;
  color: var(--accent);
  margin-bottom: 16px;
}

.section-title {
  font-family: var(--font-display);
  font-size: 42px;
  font-weight: 700;
  line-height: 1.15;
  margin-bottom: 16px;
}

.section-desc {
  font-size: 18px;
  color: var(--text-secondary);
  max-width: 640px;
}

/* BOOK MAP */
.book-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
  gap: 24px;
}

.book-card {
  background: var(--bg-surface);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 32px;
  cursor: pointer;
  transition: all 0.4s var(--ease-out-expo);
  position: relative;
  overflow: hidden;
}

.book-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: linear-gradient(90deg, var(--accent), transparent);
  opacity: 0;
  transition: opacity 0.3s ease;
}

.book-card:hover {
  border-color: var(--border-light);
  transform: translateY(-2px);
  box-shadow: 0 8px 32px rgba(0,0,0,0.3);
}

.book-card:hover::before { opacity: 1; }

.book-card-num {
  font-family: var(--font-display);
  font-size: 48px;
  font-weight: 900;
  color: var(--bg-elevated);
  position: absolute;
  top: 16px;
  right: 24px;
  line-height: 1;
  transition: color 0.3s ease;
}

.book-card:hover .book-card-num { color: var(--accent-dim); }

.book-card-label {
  font-family: var(--font-mono);
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 0.15em;
  color: var(--accent);
  margin-bottom: 12px;
}

.book-card-title {
  font-family: var(--font-display);
  font-size: 22px;
  font-weight: 700;
  line-height: 1.3;
  margin-bottom: 16px;
  padding-right: 40px;
}

.book-card-desc {
  font-size: 15px;
  color: var(--text-secondary);
  line-height: 1.65;
  margin-bottom: 20px;
}

.book-card-chapters {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
}

.chapter-tag {
  font-family: var(--font-mono);
  font-size: 10px;
  padding: 4px 10px;
  border: 1px solid var(--border);
  border-radius: 3px;
  color: var(--text-muted);
  transition: all 0.2s ease;
}

.book-card:hover .chapter-tag { border-color: var(--border-light); color: var(--text-secondary); }

/* EXPANDED CHAPTER VIEW */
.chapter-detail {
  background: var(--bg-surface);
  border: 1px solid var(--border);
  border-radius: 8px;
  margin-bottom: 20px;
  overflow: hidden;
  transition: all 0.3s ease;
}

.chapter-detail-header {
  padding: 24px 32px;
  cursor: pointer;
  display: flex;
  align-items: flex-start;
  gap: 16px;
  transition: background 0.2s ease;
}

.chapter-detail-header:hover { background: var(--bg-elevated); }

.chapter-num {
  font-family: var(--font-mono);
  font-size: 12px;
  color: var(--accent);
  min-width: 32px;
}

.chapter-detail-title {
  font-family: var(--font-display);
  font-size: 20px;
  font-weight: 700;
  flex: 1;
}

.chapter-toggle {
  font-size: 18px;
  color: var(--text-muted);
  transition: transform 0.3s ease;
}

.chapter-detail.open .chapter-toggle { transform: rotate(45deg); }

.chapter-detail-body {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.5s var(--ease-out-expo);
}

.chapter-detail.open .chapter-detail-body { max-height: 2000px; }

.chapter-detail-content {
  padding: 0 32px 32px;
  padding-left: 72px;
}

.chapter-detail-content p {
  color: var(--text-secondary);
  margin-bottom: 16px;
  font-size: 16px;
}

.chapter-detail-content .key-ideas {
  margin-top: 20px;
}

.chapter-detail-content .key-ideas h4 {
  font-family: var(--font-mono);
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 0.15em;
  color: var(--accent);
  margin-bottom: 12px;
}

.idea-chip {
  display: inline-block;
  font-family: var(--font-mono);
  font-size: 12px;
  padding: 6px 14px;
  margin: 0 6px 8px 0;
  background: var(--bg-elevated);
  border: 1px solid var(--border);
  border-radius: 4px;
  color: var(--text-secondary);
}

/* CONCEPTS SECTION */
.concepts-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
  gap: 20px;
}

.concept-card {
  background: var(--bg-surface);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 28px;
  cursor: pointer;
  transition: all 0.4s var(--ease-out-expo);
  position: relative;
}

.concept-card:hover {
  border-color: var(--accent);
  transform: translateY(-2px);
  box-shadow: 0 4px 24px rgba(201, 168, 76, 0.08);
}

.concept-card .triad-badge {
  font-family: var(--font-mono);
  font-size: 9px;
  text-transform: uppercase;
  letter-spacing: 0.15em;
  padding: 3px 10px;
  border-radius: 3px;
  display: inline-block;
  margin-bottom: 16px;
}

.triad-badge.fragile { background: var(--fragile-glow); color: var(--fragile-color); border: 1px solid var(--fragile-color); }
.triad-badge.robust { background: var(--robust-glow); color: var(--robust-color); border: 1px solid var(--robust-color); }
.triad-badge.antifragile { background: var(--antifragile-glow); color: var(--antifragile-color); border: 1px solid var(--antifragile-color); }
.triad-badge.meta { background: var(--accent-dim); color: var(--accent); border: 1px solid var(--accent); }

.concept-card h3 {
  font-family: var(--font-display);
  font-size: 22px;
  font-weight: 700;
  margin-bottom: 12px;
}

.concept-card p {
  font-size: 15px;
  color: var(--text-secondary);
  line-height: 1.65;
}

.concept-card .concept-example {
  margin-top: 16px;
  padding-top: 16px;
  border-top: 1px solid var(--border);
  font-family: var(--font-mono);
  font-size: 12px;
  color: var(--text-muted);
  line-height: 1.6;
}

.concept-card .concept-example em {
  color: var(--accent);
  font-style: normal;
}

/* CONCEPT DETAIL MODAL */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(10, 10, 8, 0.9);
  backdrop-filter: blur(8px);
  z-index: 2000;
  display: none;
  align-items: center;
  justify-content: center;
  padding: 40px;
  animation: fadeIn 0.3s ease;
}

.modal-overlay.open { display: flex; }

.modal {
  background: var(--bg-surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  max-width: 720px;
  width: 100%;
  max-height: 85vh;
  overflow-y: auto;
  padding: 48px;
  position: relative;
  animation: modalIn 0.4s var(--ease-out-expo);
}

.modal-close {
  position: absolute;
  top: 20px;
  right: 20px;
  width: 36px;
  height: 36px;
  border: 1px solid var(--border);
  border-radius: 50%;
  background: none;
  color: var(--text-muted);
  font-size: 18px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s ease;
}

.modal-close:hover { border-color: var(--text-secondary); color: var(--text-primary); }

.modal h2 {
  font-family: var(--font-display);
  font-size: 32px;
  font-weight: 700;
  margin-bottom: 8px;
}

.modal .modal-subtitle {
  font-family: var(--font-mono);
  font-size: 12px;
  color: var(--accent);
  text-transform: uppercase;
  letter-spacing: 0.1em;
  margin-bottom: 24px;
}

.modal p {
  color: var(--text-secondary);
  margin-bottom: 16px;
  font-size: 16px;
}

.modal blockquote {
  border-left: 2px solid var(--accent);
  padding: 16px 24px;
  margin: 24px 0;
  background: var(--bg-elevated);
  border-radius: 0 6px 6px 0;
  font-style: italic;
  color: var(--text-primary);
}

.modal .related-concepts {
  margin-top: 32px;
  padding-top: 24px;
  border-top: 1px solid var(--border);
}

.modal .related-concepts h4 {
  font-family: var(--font-mono);
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 0.15em;
  color: var(--text-muted);
  margin-bottom: 12px;
}

.related-tag {
  display: inline-block;
  font-family: var(--font-mono);
  font-size: 12px;
  padding: 6px 14px;
  margin: 0 6px 8px 0;
  background: var(--bg-elevated);
  border: 1px solid var(--border);
  border-radius: 4px;
  color: var(--accent);
  cursor: pointer;
  transition: all 0.2s ease;
}

.related-tag:hover { border-color: var(--accent); background: var(--accent-dim); }

/* TRIAD CLASSIFIER */
.classifier-container {
  max-width: 800px;
  margin: 0 auto;
}

.classifier-prompt {
  text-align: center;
  margin-bottom: 48px;
}

.classifier-prompt h3 {
  font-family: var(--font-display);
  font-size: 28px;
  margin-bottom: 8px;
}

.classifier-prompt p {
  color: var(--text-secondary);
}

.classifier-scenario {
  background: var(--bg-surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 40px;
  margin-bottom: 32px;
  text-align: center;
}

.scenario-num {
  font-family: var(--font-mono);
  font-size: 11px;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.15em;
  margin-bottom: 16px;
}

.scenario-text {
  font-family: var(--font-display);
  font-size: 26px;
  font-weight: 700;
  line-height: 1.35;
  margin-bottom: 8px;
}

.scenario-context {
  color: var(--text-secondary);
  font-size: 15px;
}

.classifier-options {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 16px;
  margin-bottom: 32px;
}

.classify-btn {
  padding: 20px;
  border-radius: 8px;
  border: 2px solid var(--border);
  background: var(--bg-surface);
  cursor: pointer;
  transition: all 0.3s var(--ease-spring);
  text-align: center;
}

.classify-btn:hover { transform: translateY(-2px); }

.classify-btn.fragile:hover, .classify-btn.fragile.selected { border-color: var(--fragile-color); background: var(--fragile-glow); }
.classify-btn.robust:hover, .classify-btn.robust.selected { border-color: var(--robust-color); background: var(--robust-glow); }
.classify-btn.antifragile:hover, .classify-btn.antifragile.selected { border-color: var(--antifragile-color); background: var(--antifragile-glow); }

.classify-btn .btn-icon { font-size: 28px; margin-bottom: 8px; }

.classify-btn .btn-label {
  font-family: var(--font-mono);
  font-size: 12px;
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.1em;
}

.classify-btn.fragile .btn-label { color: var(--fragile-color); }
.classify-btn.robust .btn-label { color: var(--robust-color); }
.classify-btn.antifragile .btn-label { color: var(--antifragile-color); }

.classify-btn .btn-desc {
  font-size: 12px;
  color: var(--text-muted);
  margin-top: 4px;
}

.feedback-box {
  background: var(--bg-surface);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 28px;
  display: none;
  animation: fadeUp 0.3s var(--ease-out-expo);
}

.feedback-box.visible { display: block; }

.feedback-box.correct { border-color: var(--success); }
.feedback-box.incorrect { border-color: var(--error); }

.feedback-result {
  font-family: var(--font-mono);
  font-size: 12px;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  margin-bottom: 8px;
}

.feedback-result.correct { color: var(--success); }
.feedback-result.incorrect { color: var(--error); }

.feedback-box p {
  color: var(--text-secondary);
  font-size: 15px;
}

.classifier-controls {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 24px;
}

.classifier-score {
  font-family: var(--font-mono);
  font-size: 13px;
  color: var(--text-muted);
}

.classifier-score span { color: var(--accent); font-weight: 500; }

.next-btn {
  font-family: var(--font-mono);
  font-size: 12px;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  padding: 12px 24px;
  border: 1px solid var(--accent);
  border-radius: 4px;
  background: none;
  color: var(--accent);
  cursor: pointer;
  transition: all 0.2s ease;
}

.next-btn:hover { background: var(--accent); color: var(--bg-deep); }

/* FLASHCARDS */
.flashcard-container {
  max-width: 680px;
  margin: 0 auto;
}

.flashcard-controls {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 32px;
}

.flashcard-counter {
  font-family: var(--font-mono);
  font-size: 13px;
  color: var(--text-muted);
}

.flashcard-counter span { color: var(--accent); }

.flashcard-filter {
  display: flex;
  gap: 8px;
}

.filter-btn {
  font-family: var(--font-mono);
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  padding: 6px 14px;
  border: 1px solid var(--border);
  border-radius: 4px;
  background: none;
  color: var(--text-muted);
  cursor: pointer;
  transition: all 0.2s ease;
}

.filter-btn:hover { border-color: var(--text-secondary); color: var(--text-secondary); }
.filter-btn.active { border-color: var(--accent); color: var(--accent); background: var(--accent-dim); }

.flashcard-wrapper {
  perspective: 1200px;
  margin-bottom: 32px;
}

.flashcard {
  width: 100%;
  min-height: 360px;
  position: relative;
  cursor: pointer;
  transform-style: preserve-3d;
  transition: transform 0.6s var(--ease-out-expo);
}

.flashcard.flipped { transform: rotateY(180deg); }

.flashcard-face {
  position: absolute;
  inset: 0;
  backface-visibility: hidden;
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 48px;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  text-align: center;
}

.flashcard-front {
  background: var(--bg-surface);
}

.flashcard-back {
  background: var(--bg-elevated);
  transform: rotateY(180deg);
}

.flashcard-category {
  font-family: var(--font-mono);
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 0.2em;
  color: var(--accent);
  margin-bottom: 24px;
}

.flashcard-question {
  font-family: var(--font-display);
  font-size: 26px;
  font-weight: 700;
  line-height: 1.35;
  margin-bottom: 24px;
}

.flashcard-hint {
  font-family: var(--font-mono);
  font-size: 11px;
  color: var(--text-muted);
}

.flashcard-answer {
  font-size: 17px;
  color: var(--text-secondary);
  line-height: 1.7;
  max-width: 520px;
}

.flashcard-answer strong {
  color: var(--text-primary);
}

.flashcard-nav {
  display: flex;
  justify-content: center;
  gap: 16px;
}

.card-nav-btn {
  width: 48px;
  height: 48px;
  border: 1px solid var(--border);
  border-radius: 50%;
  background: none;
  color: var(--text-secondary);
  font-size: 20px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s ease;
}

.card-nav-btn:hover { border-color: var(--accent); color: var(--accent); }

.difficulty-btns {
  display: flex;
  gap: 12px;
  margin: 0 16px;
}

.diff-btn {
  font-family: var(--font-mono);
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  padding: 12px 20px;
  border: 1px solid var(--border);
  border-radius: 4px;
  background: none;
  color: var(--text-muted);
  cursor: pointer;
  transition: all 0.2s ease;
}

.diff-btn:hover { border-color: var(--text-secondary); color: var(--text-secondary); }
.diff-btn.easy:hover { border-color: var(--success); color: var(--success); }
.diff-btn.hard:hover { border-color: var(--error); color: var(--error); }
.diff-btn.good:hover { border-color: var(--accent); color: var(--accent); }

/* QUIZ */
.quiz-container {
  max-width: 740px;
  margin: 0 auto;
}

.quiz-progress {
  display: flex;
  gap: 4px;
  margin-bottom: 40px;
}

.quiz-dot {
  flex: 1;
  height: 4px;
  border-radius: 2px;
  background: var(--border);
  transition: background 0.3s ease;
}

.quiz-dot.correct { background: var(--success); }
.quiz-dot.incorrect { background: var(--error); }
.quiz-dot.current { background: var(--accent); }

.quiz-question-card {
  background: var(--bg-surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 48px;
  margin-bottom: 24px;
}

.quiz-q-num {
  font-family: var(--font-mono);
  font-size: 11px;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.15em;
  margin-bottom: 16px;
}

.quiz-q-text {
  font-family: var(--font-display);
  font-size: 24px;
  font-weight: 700;
  line-height: 1.4;
  margin-bottom: 32px;
}

.quiz-options {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.quiz-option {
  padding: 18px 24px;
  border: 1px solid var(--border);
  border-radius: 8px;
  background: var(--bg-elevated);
  cursor: pointer;
  font-size: 16px;
  color: var(--text-secondary);
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  gap: 16px;
}

.quiz-option:hover { border-color: var(--accent); color: var(--text-primary); }

.quiz-option .option-letter {
  font-family: var(--font-mono);
  font-size: 12px;
  width: 28px;
  height: 28px;
  border: 1px solid var(--border);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  transition: all 0.2s ease;
}

.quiz-option:hover .option-letter { border-color: var(--accent); color: var(--accent); }

.quiz-option.selected { border-color: var(--accent); background: var(--accent-dim); }
.quiz-option.correct { border-color: var(--success); background: rgba(90, 158, 111, 0.1); }
.quiz-option.incorrect { border-color: var(--error); background: rgba(201, 64, 64, 0.1); }
.quiz-option.disabled { pointer-events: none; }

.quiz-explanation {
  background: var(--bg-surface);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 24px;
  margin-top: 16px;
  display: none;
}

.quiz-explanation.visible { display: block; animation: fadeUp 0.3s var(--ease-out-expo); }

.quiz-explanation p {
  color: var(--text-secondary);
  font-size: 15px;
}

.quiz-results {
  text-align: center;
  padding: 60px 40px;
}

.quiz-results h3 {
  font-family: var(--font-display);
  font-size: 36px;
  margin-bottom: 16px;
}

.quiz-score {
  font-family: var(--font-display);
  font-size: 72px;
  font-weight: 900;
  color: var(--accent);
  margin-bottom: 16px;
}

.quiz-results p {
  color: var(--text-secondary);
  margin-bottom: 32px;
}

.restart-btn {
  font-family: var(--font-mono);
  font-size: 12px;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  padding: 14px 32px;
  border: 1px solid var(--accent);
  border-radius: 4px;
  background: var(--accent);
  color: var(--bg-deep);
  cursor: pointer;
  transition: all 0.2s ease;
}

.restart-btn:hover { background: transparent; color: var(--accent); }

/* PROGRESS SECTION */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 20px;
  margin-bottom: 48px;
}

.stat-card {
  background: var(--bg-surface);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 28px;
  text-align: center;
}

.stat-value {
  font-family: var(--font-display);
  font-size: 42px;
  font-weight: 900;
  color: var(--accent);
  margin-bottom: 4px;
}

.stat-label {
  font-family: var(--font-mono);
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 0.15em;
  color: var(--text-muted);
}

.mastery-section {
  margin-bottom: 48px;
}

.mastery-section h3 {
  font-family: var(--font-display);
  font-size: 24px;
  margin-bottom: 24px;
}

.mastery-item {
  display: flex;
  align-items: center;
  gap: 20px;
  padding: 16px 0;
  border-bottom: 1px solid var(--border);
}

.mastery-label {
  font-size: 15px;
  min-width: 200px;
}

.mastery-bar-bg {
  flex: 1;
  height: 6px;
  background: var(--bg-elevated);
  border-radius: 3px;
  overflow: hidden;
}

.mastery-bar {
  height: 100%;
  border-radius: 3px;
  background: linear-gradient(90deg, var(--accent), var(--antifragile-color));
  transition: width 1s var(--ease-out-expo);
}

.mastery-pct {
  font-family: var(--font-mono);
  font-size: 12px;
  color: var(--text-muted);
  min-width: 40px;
  text-align: right;
}

/* ANIMATIONS */
@keyframes fadeUp {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes modalIn {
  from { opacity: 0; transform: translateY(30px) scale(0.97); }
  to { opacity: 1; transform: translateY(0) scale(1); }
}

@keyframes scrollPulse {
  0% { top: -40px; }
  100% { top: 40px; }
}

/* RESPONSIVE */
@media (max-width: 768px) {
  .section { padding: 80px 20px 60px; }
  .nav-inner { padding: 0 20px; }
  .nav-tab span { display: none; }
  .hero { padding: 100px 20px 60px; }
  .hero-triad { gap: 24px; }
  .book-grid { grid-template-columns: 1fr; }
  .concepts-grid { grid-template-columns: 1fr; }
  .classifier-options { grid-template-columns: 1fr; }
  .stats-grid { grid-template-columns: repeat(2, 1fr); }
  .modal { padding: 32px 24px; }
}

/* CHAPTER PRIORITY & FILTER */
.chapter-priority {
  font-family: var(--font-mono);
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  padding: 3px 10px;
  border-radius: 3px;
  flex-shrink: 0;
}
.chapter-priority.must-read {
  background: var(--antifragile-glow);
  color: var(--antifragile-color);
  border: 1px solid var(--antifragile-color);
}
.chapter-priority.optional {
  background: var(--robust-glow);
  color: var(--robust-color);
  border: 1px solid var(--robust-color);
}
.chapter-oneliner {
  font-size: 13px;
  color: var(--text-muted);
  font-style: italic;
  margin-top: 4px;
  line-height: 1.5;
}
.chapter-filter {
  display: flex;
  gap: 8px;
  margin-bottom: 24px;
}
.chapter-filter-btn {
  font-family: var(--font-mono);
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  padding: 6px 14px;
  border: 1px solid var(--border);
  border-radius: 4px;
  background: none;
  color: var(--text-muted);
  cursor: pointer;
  transition: all 0.2s ease;
}
.chapter-filter-btn:hover { border-color: var(--text-secondary); color: var(--text-secondary); }
.chapter-filter-btn.active { border-color: var(--accent); color: var(--accent); background: var(--accent-dim); }
.book-card-meta {
  display: flex;
  gap: 12px;
  margin-top: 12px;
  font-family: var(--font-mono);
  font-size: 11px;
}
.book-card-meta .meta-must { color: var(--antifragile-color); }
.book-card-meta .meta-optional { color: var(--robust-color); }
.chapter-detail-content .next-btn {
  margin-top: 20px;
  display: inline-block;
  text-decoration: none;
}
</style>
</head>
<body>

<!-- NAVIGATION -->
<nav id="mainNav">
  <div class="nav-inner">
    <div class="nav-logo" onclick="showSection('hero')">反<span>脆弱</span></div>
    <div class="nav-tabs">
      <button class="nav-tab active" onclick="showSection('hero')"><span>首页</span></button>
      <button class="nav-tab" onclick="showSection('map')"><span>全书导览</span></button>
      <button class="nav-tab" onclick="showSection('concepts')"><span>核心概念</span></button>
      <button class="nav-tab" onclick="showSection('classifier')"><span>三元分类</span></button>
      <button class="nav-tab" onclick="showSection('flashcards')"><span>闪卡复习</span></button>
      <button class="nav-tab" onclick="showSection('quiz')"><span>测验</span></button>
      <button class="nav-tab" onclick="showSection('progress')"><span>学习进度</span></button>
    </div>
  </div>
  <div class="progress-bar" id="progressBar"></div>
</nav>

<!-- HERO -->
<section class="section active" id="hero-section">
  <div class="hero">
    <div class="hero-subtitle">纳西姆·尼古拉斯·塔勒布</div>
    <h1 class="hero-title">反<em>脆弱</em></h1>
    <p class="hero-desc">从无序中获益。一本掌握反脆弱性、可选择性和非线性思维的交互式学习指南。</p>
    <div class="hero-triad">
      <div class="triad-item">
        <div class="triad-icon fragile">&#9876;</div>
        <span class="triad-label fragile">脆弱</span>
      </div>
      <div class="triad-item">
        <div class="triad-icon robust">&#9672;</div>
        <span class="triad-label robust">强韧</span>
      </div>
      <div class="triad-item">
        <div class="triad-icon antifragile">&#10038;</div>
        <span class="triad-label antifragile">反脆弱</span>
      </div>
    </div>
    <div class="scroll-hint" onclick="showSection('map')" style="cursor:pointer">
      <span>开始探索</span>
      <div class="scroll-line"></div>
    </div>
  </div>
</section>

<!-- BOOK MAP -->
<section class="section" id="map-section">
  <div class="section-header">
    <div class="section-label">结构</div>
    <h2 class="section-title">全书导览</h2>
    <p class="section-desc">七卷二十五章，追溯塔勒布从命名反脆弱性到其伦理含义的论证架构。</p>
  </div>
  <div id="bookMapContent"></div>
</section>

<!-- CONCEPTS -->
<section class="section" id="concepts-section">
  <div class="section-header">
    <div class="section-label">核心理念</div>
    <h2 class="section-title">关键概念</h2>
    <p class="section-desc">《反脆弱》中的核心思维模型。点击任意概念，深入探索其内涵、关联与现实应用。</p>
  </div>
  <div class="concepts-grid" id="conceptsGrid"></div>
</section>

<!-- TRIAD CLASSIFIER -->
<section class="section" id="classifier-section">
  <div class="section-header">
    <div class="section-label">互动练习</div>
    <h2 class="section-title">三元分类游戏</h2>
    <p class="section-desc">将现实场景分类为脆弱、强韧或反脆弱。训练你对本书核心框架的直觉。</p>
  </div>
  <div class="classifier-container" id="classifierContainer"></div>
</section>

<!-- FLASHCARDS -->
<section class="section" id="flashcards-section">
  <div class="section-header">
    <div class="section-label">间隔重复</div>
    <h2 class="section-title">闪卡复习</h2>
    <p class="section-desc">通过间隔重复复习核心概念。点击翻转，评估记忆程度，系统将优先安排你最需要复习的内容。</p>
  </div>
  <div class="flashcard-container" id="flashcardContainer"></div>
</section>

<!-- QUIZ -->
<section class="section" id="quiz-section">
  <div class="section-header">
    <div class="section-label">自我测试</div>
    <h2 class="section-title">理解力测验</h2>
    <p class="section-desc">十道测试深层理解而非表面记忆的题目。每题附有解析以巩固学习。</p>
  </div>
  <div class="quiz-container" id="quizContainer"></div>
</section>

<!-- PROGRESS -->
<section class="section" id="progress-section">
  <div class="section-header">
    <div class="section-label">学习分析</div>
    <h2 class="section-title">你的进度</h2>
    <p class="section-desc">追踪所有学习模式的掌握程度。数据保存在浏览器中。</p>
  </div>
  <div id="progressContent"></div>
</section>

<!-- MODAL -->
<div class="modal-overlay" id="modalOverlay">
  <div class="modal" id="modalContent"></div>
</div>

<script>
// =============== DATA ===============

const books = [
  {
    num: 'I',
    title: '反脆弱：导论',
    desc: '通过达摩克利斯、凤凰和九头蛇的隐喻引入脆弱-强韧-反脆弱的核心三元组。展示过度补偿、有机与工程的区别以及层级脆弱性如何支撑这一概念。',
    chapters: [
      { num: 1, title: '达摩克利斯与九头蛇之间', oneliner: '引入"反脆弱"这一缺失词汇，建立脆弱-强韧-反脆弱三元框架', summary: '引入"反脆弱"这一缺失词汇。三元组：达摩克利斯（脆弱，剑悬于发丝之上）、凤凰（强韧，涅槃重生但不变）、九头蛇（反脆弱，砍掉一个头长出两个）。领域依赖性解释了为什么我们无法在不同领域间转移这一洞察。', ideas: ['三元组', '领域依赖性', '达摩克利斯-凤凰-九头蛇'], priority: 'must-read' },
      { num: 2, title: '过度补偿与过度反应无处不在', oneliner: '反脆弱常通过过度补偿表现：压力使系统变得更强', summary: '反脆弱性常通过过度补偿表现：肌肉因压力变强，被禁书籍卖得更多，创伤后成长。自然界的冗余是反脆弱的响应，而非低效。', ideas: ['过度补偿', '冗余', '毒物兴奋效应', '史翠珊效应'], priority: 'must-read' },
      { num: 3, title: '猫与洗衣机', oneliner: '有机体（猫）与机械体（洗衣机）有本质区别，复杂系统需要变异性', summary: '有机体（猫）与工程产物（洗衣机）有本质区别。复杂系统需要变异性和压力源。"旅游化"剥夺了生活的波动性，使事物变得脆弱。', ideas: ['有机vs机械', '旅游化', '压力源即信息'], priority: 'optional' },
      { num: 4, title: '杀死我的东西却使他人更强', oneliner: '反脆弱在层级中运作：系统从其组件的脆弱中获益', summary: '反脆弱性在层级中运作：系统从其组成部分的脆弱中获益。进化需要个体的失败。错误对于集体学习至关重要。向企业家和冒险者致敬——他们为系统吸收了脆弱性。', ideas: ['层级反脆弱', '进化', '错误即投资'], priority: 'must-read' }
    ]
  },
  {
    num: 'II',
    title: '现代性与对反脆弱性的否定',
    desc: '现代性的普罗克汝斯忒斯之床：自上而下的系统、天真的干预、过度稳定化和预测崇拜如何压制复杂系统的自然反脆弱性。',
    chapters: [
      { num: 5, title: '集市与办公楼', oneliner: '两兄弟的故事：波动的集市收入vs稳定的办公室薪水', summary: '两兄弟：一个在波动的集市工作（反脆弱的职业），另一个在稳定的办公室（脆弱的职业）。瑞士的自下而上结构对比集中制国家。火鸡问题：稳定滋生隐藏的脆弱性。', ideas: ['自下而上vs自上而下', '平均斯坦vs极端斯坦', '火鸡问题'], priority: 'must-read' },
      { num: 6, title: '告诉他们我爱（某些）随机性', oneliner: '小扰动防止大爆发，过度稳定化是定时炸弹', summary: '政治退火：小扰动防止大爆发。过度稳定化是定时炸弹。小战争可能防止大战争。现代性试图消除波动性反而制造了脆弱性。', ideas: ['退火', '过度稳定化', '小火防止大火'], priority: 'optional' },
      { num: 7, title: '天真的干预', oneliner: '医源性伤害：治疗者造成的伤害，对复杂系统的干预常常适得其反', summary: '医源性伤害：治疗者造成的伤害。对复杂系统的干预常常适得其反。噪声-信号问题：大多数"信息"是噪声，基于噪声干预会造成伤害。费边式拖延是一种智慧。', ideas: ['医源性伤害', '噪声vs信号', '拖延即策略'], priority: 'must-read' },
      { num: 8, title: '预测是现代性之子', oneliner: '现代对预测的执迷，以及为何应从预测转向准备', summary: '现代对预测的执迷。预测罕见事件的不可能性。从预测转向准备。通过关注脆弱性检测而非预测来成为"非火鸡"。', ideas: ['非预测', '脆弱性检测', '非火鸡'], priority: 'optional' }
    ]
  },
  {
    num: 'III',
    title: '非预测的世界观',
    desc: '胖子托尼、塞内加与杠铃策略：通过不对称定位和斯多葛式情感强韧性，在不做预测的情况下蓬勃发展的实用工具。',
    chapters: [
      { num: 9, title: '胖子托尼与脆弱推手', oneliner: '胖子托尼：不做预测但能嗅出脆弱性的街头智者', summary: '胖子托尼：不做预测但能嗅出脆弱性的街头智者。脆弱推手：通过天真理性主义使系统脆弱化的人。图书馆的反脆弱性：通过广泛阅读收集可选择性。', ideas: ['胖子托尼', '脆弱推手', '嗅出脆弱性'], priority: 'optional' },
      { num: 10, title: '塞内加的上行与下行', oneliner: '塞内加式反脆弱思维：预演损失以消除下行风险', summary: '塞内加作为原始反脆弱思想家：心理预演损失以消除下行风险。根本的不对称性：反脆弱事物的上行大于下行。通过斯多葛主义进行情感强韧化。', ideas: ['斯多葛主义', '不对称性', '情感强韧化', '塞内加'], priority: 'must-read' },
      { num: 11, title: '千万别嫁给摇滚明星', oneliner: '杠铃策略：结合极端安全与极端风险，避开中间地带', summary: '杠铃策略：结合极端安全与极端风险，不要中间地带。会计师（安全）加摇滚明星（疯狂）胜过中等风险的办公室经理。适用于职业、投资、阅读、社交。', ideas: ['杠铃策略', '双峰策略', '驯服不确定性'], priority: 'must-read' }
    ]
  },
  {
    num: 'IV',
    title: '可选择性、技术与反脆弱的智慧',
    desc: '试验、可选择性和理性漫游者如何超越定向研究和正式教育。叙事与实践之间的张力。',
    chapters: [
      { num: 12, title: '泰勒斯的甜葡萄', oneliner: '可选择性：有权但无义务行动，有限下行、无限上行', summary: '可选择性：有权但无义务行动。泰勒斯购买了橄榄压榨机的期权。不对称收益：有限下行，无限上行。生活是"做多波动率"。理性漫游者追随可选择性而非计划。', ideas: ['可选择性', '不对称收益', '理性漫游者', '做多波动率'], priority: 'must-read' },
      { num: 13, title: '教鸟儿如何飞', oneliner: '苏联-哈佛错觉：学术界窃取实践者发现的功劳', summary: '苏联-哈佛错觉：学术界窃取实践者发现的功劳。副现象：混淆相关与因果。研究跟随实践多于反过来。创新历史中的叙述谬误。', ideas: ['苏联-哈佛错觉', '副现象', '实践先于理论'], priority: 'must-read' },
      { num: 14, title: '当两件事不是"同一件事"', oneliner: '绿色木材谬误：混淆知识的来源与知识本身', summary: '绿色木材谬误：混淆知识的来源与知识本身。一个交易员靠交易绿色木材（新砍伐的木材）发了财，却以为绿色木材是涂了绿漆的。实践知识与理论知识不同。', ideas: ['绿色木材谬误', '默会知识', '认知vs技艺'], priority: 'optional' },
      { num: 15, title: '失败者书写的历史', oneliner: '技术史被学术界改写，试错而非研究驱动了大多数创新', summary: '技术史被学术界改写，他们窃取了匠人的功劳。逆向火鸡：试错而非研究驱动了大多数创新。政府应资助非目的论的试验。', ideas: ['逆向火鸡', '非目的论试验', '历史改写'], priority: 'optional' },
      { num: 16, title: '论无序的教训', oneliner: '过度安排的足球妈妈扼杀了反脆弱性', summary: '过度安排孩子日程的足球妈妈扼杀了反脆弱性。杠铃式教育：结构化经典加非结构化探索。生态式（现实的混乱）对比游戏式（课堂的整洁）。', ideas: ['杠铃式教育', '生态vs游戏', '足球妈妈问题'], priority: 'optional' },
      { num: 17, title: '胖子托尼与苏格拉底辩论', oneliner: '你可以做到你无法解释的事，传统编码了形式逻辑遗漏的智慧', summary: '胖子托尼挑战苏格拉底式理性主义。你可以做到你无法解释的事。传统编码了形式逻辑遗漏的智慧。傻瓜/非傻瓜的区分比真/假更重要。', ideas: ['反理性主义', '默会智慧', '傻瓜-非傻瓜'], priority: 'optional' }
    ]
  },
  {
    num: 'V',
    title: '非线性与非线性',
    desc: '凸性和凹性作为脆弱性检测的数学基础。为什么规模导致脆弱化以及如何检测谁将崩溃。',
    chapters: [
      { num: 18, title: '一块大石头与一千颗小石子的区别', oneliner: '脆弱性是非线性的：大石头造成的伤害远超等重小石子之和', summary: '脆弱性是非线性的：一块大石头造成的伤害远超一千颗等重小石子。凹性=脆弱（大冲击伤害更大），凸性=反脆弱（从波动中获益）。规模导致脆弱化：越大越脆弱。', ideas: ['非线性', '凹性/凸性', '规模导致脆弱化', '挤压效应'], priority: 'must-read' },
      { num: 19, title: '点石成金及其反面', oneliner: '詹森不等式：检测脆弱性的数学关键', summary: '詹森不等式：检测脆弱性的关键。如果函数是凸的，结果的平均值超过平均值的结果。这是将不确定性转化为优势的"点石成金术"。', ideas: ['詹森不等式', '点石成金', '模型误差'], priority: 'optional' }
    ]
  },
  {
    num: 'VI',
    title: '否定法',
    desc: '减法知识：学习去除什么而非添加什么。林迪效应、医学医源性以及缺席的智慧。',
    chapters: [
      { num: 20, title: '时间与脆弱性', oneliner: '林迪效应：非易逝事物的预期寿命随年龄增长而增加', summary: '林迪效应：对非易逝事物，预期寿命随年龄增加。一本存活100年的书可能再存活100年。新事物狂热——对新事物的沉迷——是脆弱的。技术在最佳状态下替代脆弱事物。', ideas: ['林迪效应', '新事物狂热', '否定法', '时间作为过滤器'], priority: 'must-read' },
      { num: 21, title: '医学、凸性与不透明性', oneliner: '医学医源性：治疗对轻症患者的伤害大于帮助', summary: '医学医源性伤害：治疗对轻症患者的伤害大于帮助。重症患者有凸性收益（治疗的大上行）；健康者有凹性敞口（更多要失去的）。自然的不透明逻辑优于我们的理解。', ideas: ['医学医源性', '凸性收益', '不透明性'], priority: 'optional' },
      { num: 22, title: '活得久，但不要太久', oneliner: '减法为生命增值：断食、去除糖分、步行代替健身房', summary: '减法为生命增值：断食、去除糖分、步行代替健身房。有机体与环境的匹配决定健康。随机营养中的凸性效应（间歇性压力源有益）。', ideas: ['减法', '间歇性断食', '饮食中的毒物兴奋'], priority: 'optional' }
    ]
  },
  {
    num: 'VII',
    title: '脆弱性与反脆弱性的伦理',
    desc: '风险共担作为反脆弱性的伦理基础。为什么将脆弱性转嫁他人的人是真正的敌人，以及为什么英雄主义意味着吸收风险。',
    chapters: [
      { num: 23, title: '风险共担', oneliner: '决策者必须承担后果，永远不要将脆弱性转嫁给他人', summary: '代理人问题：那些将脆弱性转嫁给他人的人（银行家、政客、学者）。汉谟拉比法典：如果建造者的房屋倒塌并杀死屋主，建造者将被处死。罗伯特·鲁宾问题：获取上行而无下行。灵魂参与：信念的承诺。', ideas: ['风险共担', '代理人问题', '汉谟拉比', '罗伯特·鲁宾问题'], priority: 'must-read' },
      { num: 24, title: '将伦理融入职业', oneliner: '没有独立性的财富是脆弱的，集体可能在个人知情时犯错', summary: '没有独立性的财富是脆弱的。集体可能在个人知情时犯错。大数据给研究者一个危险的"选择权"来挑选结果。集体意见的暴政。', ideas: ['伦理不对称', '集体盲目', '研究者的选择权'], priority: 'optional' },
      { num: 25, title: '结论', oneliner: '一切从波动中获益或受损，脆弱性可测量而风险不可', summary: '一切从波动中获益或受损。脆弱性在风险不可测量时是可测量的。核心信息：识别并减少脆弱性，为反脆弱做准备，永远不要将你的脆弱性转嫁给他人。', ideas: ['核心论点', '脆弱性的可测量性'], priority: 'optional' }
    ]
  }
];

const concepts = [
  { id: 'triad', name: '三元组', badge: 'meta', short: '根本分类：脆弱（被波动伤害）、强韧（无所谓）、反脆弱（从波动中获益）。全书的组织框架。', example: '达摩克利斯（脆弱）、凤凰（强韧）、九头蛇（反脆弱）', detail: '三元组是塔勒布的核心组织原则。世界上的一切都可以按其对波动性、随机性和压力源的反应来分类。脆弱的事物在压力下破碎（如瓷杯）。强韧的事物抵抗压力（如石头）。反脆弱的事物在压力下实际改善（如免疫系统）。不对称测试：如果某物从随机事件中获得的上行多于下行，它就是反脆弱的。', quote: '反脆弱超越了韧性或强韧。韧性抵抗冲击保持不变；反脆弱变得更好。', related: ['barbell', 'convexity', 'optionality'] },
  { id: 'barbell', name: '杠铃策略', badge: 'antifragile', short: '结合极端安全与极端风险，避开中间地带。一种限制下行同时保留无限上行的双峰方法。', example: '90%国债+10%投机性赌注优于100%"中等风险"', detail: '杠铃策略避开给人安全幻觉的"中间地带"。相反，将一个极端（超保守，防止毁灭）与另一个极端（有无限上行的激进小赌注）结合。关键洞察：你知道最大损失（激进端），但不知道最大收益。应用于职业：稳定日常工作+疯狂副业。阅读：严谨经典+随机探索。社交：深厚密友+众多泛泛之交。', quote: '杠铃可以被视为对不确定性的驯服，一种如何长寿的理性形式。', related: ['triad', 'optionality', 'convexity'] },
  { id: 'optionality', name: '可选择性', badge: 'antifragile', short: '有权但无义务行动。下行有限、上行无限的期权是反脆弱性的最纯粹形式。', example: '泰勒斯低价购买橄榄压榨机期权，在丰收时大赚特赚', detail: '可选择性是不确定性下理性决策的关键。当你有选择权时，你从波动中获益：如果事情顺利，你行使选择权；如果不顺利，你以小额损失退出。这种不对称——有限下行、无限上行——是反脆弱性的数学核心。理性漫游者不制定固定行程，而是收集选项并追随最有前景的那些。小错误的试错就是实践中的可选择性。', quote: '选择权=不对称性+理性。选择权是反脆弱性的代理人。', related: ['barbell', 'convexity', 'tinkering'] },
  { id: 'iatrogenics', name: '医源性伤害', badge: 'fragile', short: '治疗者造成的伤害。当对复杂系统的干预造成的损害超过原始问题时。现代性中最被忽视的概念。', example: '放血术杀死的病人比它救的更多。现代等价物：对轻症过度用药。', detail: '医源性伤害远不止医学领域。在经济学中，央行干预常常放大危机。在教育中，过度安排扼杀创造力。在外交政策中，政权更迭制造混乱。核心原则：在复杂系统中，首要原则应该是"不要造成伤害"。不对称性至关重要：对重症（凸性收益），激进治疗合理。对轻症（凹性收益），治疗风险超过疾病风险。', quote: '在复杂世界中，权重在尾部，医源性伤害从来不会立即被看到。', related: ['naiveintervention', 'vianegativa', 'convexity'] },
  { id: 'skininthegame', name: '风险共担', badge: 'meta', short: '决策者必须承担后果。伦理基础：不可以牺牲他人的脆弱性来换取自己的反脆弱性。', example: '汉谟拉比法典：如果建造者的房屋倒塌杀死屋主，建造者将被处死。', detail: '风险共担既是伦理规则，也是脆弱性过滤器。当决策者承担行为后果时，系统通过反馈自我修正。当他们不承担时（银行家从风险中获利但被救助），脆弱性被转嫁给他人并在系统中累积。罗伯特·鲁宾问题：他在花旗集团赚了1.2亿美元，银行倒闭时纳税人买单，没有追回机制。灵魂参与更进一步：信念承诺意味着信仰你所倡导的。', quote: '首要伦理规则如下：不可以牺牲他人的脆弱性来换取自己的反脆弱性。', related: ['triad', 'hammurabi', 'agency'] },
  { id: 'lindy', name: '林迪效应', badge: 'robust', short: '对非易逝事物，预期寿命随年龄增加。一项存活了1000年的技术或理念可能再存活1000年。', example: '2000年前的书（荷马、圣经）很可能再被阅读2000年。', detail: '林迪效应适用于理念、技术、书籍、文化规范——任何非易逝的事物。与生物体（会衰老和死亡）不同，经受住时间考验的非易逝事物已证明了其强韧性。每多存活一年，意味着更长的未来预期寿命。这深刻地反对新事物狂热：新事物是脆弱的，旧事物是强韧的。实际应用：偏好经时间考验的方案，对"最新"事物持怀疑态度，读老书。', quote: '如果一本书已印刷四十年，我可以预期它再印刷四十年。', related: ['vianegativa', 'neomania', 'triad'] },
  { id: 'convexity', name: '凸性与凹性', badge: 'meta', short: '数学基础：凸性=从上行获益多于被下行伤害（反脆弱）。凹性=反之（脆弱）。石头对比石子测试。', example: '交通：10万辆车分2小时通过的影响 远小于 10万辆车1小时通过。交通是凹性的=对集中脆弱。', detail: '这是塔勒布最技术性但最有力的概念。对变量的凸性响应意味着你从其波动中获益：正面结果的收益超过负面结果的损失。凹性则相反。测试："两个结果的平均值好，还是平均值的结果好？"对凸性收益，你需要方差。对凹性，你需要稳定。詹森不等式将此形式化。规模导致脆弱化，因为更大的实体对冲击更凹。', quote: '简单来说，凸性收益从不确定性和变异性中获益——如果你拥有这个加上"长期"收益，你就是反脆弱的。', related: ['triad', 'optionality', 'jensens'] },
  { id: 'vianegativa', name: '否定法', badge: 'antifragile', short: '减法的力量：知道该去除什么比知道该添加什么更强韧。减法知识比加法知识更持久。', example: '戒烟比添加任何保健品更确定地改善健康。', detail: '否定法——否定之路——是最可操作的原则之一。在医学中：先停止伤害再尝试帮助。在饮食中：去除糖比添加超级食品先行。在商业中：消除下行风险先于追逐上行。在知识中：证伪（知道什么是错的）比证实（知道什么是对的）更强韧。江湖骗子增加复杂性；智者减少它。', quote: '我们对什么是错的知道得比什么是对的多得多。否定知识更加强韧。', related: ['iatrogenics', 'lindy', 'subtraction'] },
  { id: 'tinkering', name: '非目的论试验', badge: 'antifragile', short: '无方向的试错在突破性创新方面优于定向研究。苏联-哈佛错觉说的相反，但历史不同意。', example: '喷气发动机、抗生素和大多数重大创新来自试验摸索，而非学术研究。', detail: '塔勒布认为大多数技术创新来自实践者通过试错的摸索，而非自上而下的研究计划。学术界随后写论文解释实践者的发现并窃取功劳——"教鸟儿飞"效应。这就是苏联-哈佛错觉：相信定向的、自上而下的研究驱动进步。实际上，政府应资助广泛的、非目的论的实验而非定向研究。', quote: '我们不是把理论付诸实践。我们从实践中创造理论。', related: ['optionality', 'greenlumber', 'sovietharvarddept'] },
  { id: 'turkeyproblem', name: '火鸡问题', badge: 'fragile', short: '一只被喂了1000天的火鸡"确认"人类是善意的——直到感恩节。复杂系统中的过去表现隐藏着灾难性风险。', example: '银行在2008年之前多年看起来安全且盈利，恰恰是因为它们在积累隐藏的脆弱性。', detail: '火鸡问题是塔勒布对天真经验主义危险的生动比喻：用过去的稳定性作为未来安全的证据。每一天的喂食都"确认"火鸡的模型，同时却在建设走向灾难。问题是结构性的，不是概率性的——火鸡无法从其数据集中计算感恩节的风险。应用于金融、政治和个人生活：长期的表面稳定是最危险的，因为它允许隐藏的脆弱性累积。', quote: '一只火鸡被喂了一千天——每天都在向它确认生活的一般规律是被喂食。然后感恩节来了。', related: ['skininthegame', 'convexity', 'triad'] },
  { id: 'greenlumber', name: '绿色木材谬误', badge: 'meta', short: '混淆重要知识的来源与另一种不太相关的知识。一个成功的交易员以为"绿色木材"是涂了绿漆的。', example: '一个交易员靠交易绿色木材（新砍伐的木材）赚了数百万，却以为它是涂了绿漆的木材。他的实践知识才是关键。', detail: '绿色木材谬误表明，人们认为驱动成功的知识往往与实际驱动成功的知识无关。成功的绿色木材交易员对供需和市场动态有超群的实践直觉——"绿色"的定义无关紧要。这广泛适用：不要混淆清晰的理论知识与实际产生结果的混乱的默会知识。能最好解释的人不一定是能最好执行的人。', quote: '人们可能因为错误的原因而有正确的启发式。诀窍在于他们错误的原因可能比正确的原因更好。', related: ['tinkering', 'optionality', 'triad'] },
  { id: 'hormesis', name: '毒物兴奋效应', badge: 'antifragile', short: '少量有害物质或压力源实际上对有机体有益。剂量决定是毒药还是良药。', example: '少量辐射、间歇性断食、冷暴露和运动都会触发过度补偿。', detail: '毒物兴奋效应是自然在生物层面的反脆弱机制。小压力源触发过度补偿：肌肉从微撕裂中生长，骨骼从冲击中变强，免疫系统从暴露中改善。关键是正确的剂量：太少的压力导致萎缩，太多导致毁坏，但适度的压力源触发不成比例的正面反应。这就是为什么舒适和缺乏挑战是变相的危险。', quote: '人类不知怎样能完全领会适度剂量的压力源的有益性质。', related: ['triad', 'vianegativa', 'overcompensation'] }
];

const scenarios = [
  { text: '一家根据客户反馈进行转型的初创企业', context: '每次失败都在教导和重新定向', answer: 'antifragile', explanation: '这家初创企业利用负面信息（什么不起作用）来改进。每次失败都是一个提供信息的选择权，使公司通过波动变得更强。' },
  { text: '地震中架子上的瓷花瓶', context: '无法从无序中获益', answer: 'fragile', explanation: '花瓶只能被冲击伤害，永远不会改善。它从波动中只有纯粹的下行——脆弱的定义。' },
  { text: '按精确规格设计的混凝土桥', context: '为承受特定负荷而建', answer: 'robust', explanation: '桥在设计极限内抵抗冲击但不会因此改善。它是强韧的但不是反脆弱的——超出规格就脆弱了。' },
  { text: '一家根据销售情况调整菜单的餐厅', context: '试错实践中', answer: 'antifragile', explanation: '每天提供选项：保留有效的，放弃无效的。餐厅拥有可选择性并从顾客偏好的波动中获益。' },
  { text: '终身制政府官僚的职业', context: '稳定工资，没有市场暴露', answer: 'fragile', explanation: '尽管看似稳定，这是火鸡问题。隐藏的脆弱性在重组来临时显现——没有适应能力，没有市场技能，单一事件带来灾难性下行。' },
  { text: '自然选择的进化', context: '物种通过世代适应', answer: 'antifragile', explanation: '进化通过个体的脆弱性在物种层面是反脆弱的。错误和随机性驱动适应。系统从无序中获益。' },
  { text: '分散化的股票指数基金', context: '分散在数千家公司', answer: 'robust', explanation: '分散化提供强韧性——个体失败不会摧毁整体。但基金不会主动从波动中获益；它只是存活下来。' },
  { text: '高杠杆银行', context: '借入30倍资本以放大收益', answer: 'fragile', explanation: '杠杆是凹性的实践：正常条件下小收益，但冲击时灾难性损失。伪装成效率的极端脆弱性。' },
  { text: '轻微感染后的免疫系统', context: '暴露建立抵抗力', answer: 'antifragile', explanation: '经典毒物兴奋效应：小压力源（轻微感染）触发过度补偿，产生抗体使系统比以前更强。教科书式的反脆弱。' },
  { text: '僵化的五年企业战略规划', context: '提前设定详细里程碑和KPI', answer: 'fragile', explanation: '该计划假设可预测性。每次偏差都是"失败"。它对不确定性是凹性的——环境越波动，表现越差。对比基于可选择性的方法。' },
  { text: '被禁后销量飙升数百万的作者', context: '史翠珊效应', answer: 'antifragile', explanation: '信息是反脆弱的：压制它的企图反而放大了它。禁令是使书受益的压力源。这是通过他人过度反应实现的反脆弱。' },
  { text: '出租车司机的收入vs银行家的薪水', context: '日波动vs年稳定', answer: 'antifragile', explanation: '出租车司机有日收入波动（许多小压力源，没有单一灾难性风险），而银行家看似稳定却面临火鸡问题式的脆弱。每日小随机性是反脆弱的。' },
  { text: '间歇性断食', context: '在进食与不进食之间交替', answer: 'antifragile', explanation: '身体对食物匮乏的压力源以毒物兴奋效应回应：改善胰岛素敏感性、细胞修复、代谢灵活性。变异性本身就是益处。' },
  { text: '大规模集中式电网', context: '一个故障可能级联', answer: 'fragile', explanation: '集中化和规模创造凹性。单点故障可以级联波及整个系统。规模导致脆弱化。对比分布式微电网。' },
  { text: '瑞士州级政治体制', context: '分散的、自下而上的治理', answer: 'antifragile', explanation: '小单元可以失败而不摧毁整体。本地实验和适应。自下而上的变异通过小的、可控的错误创造系统反脆弱性。' },
  { text: '杠铃投资组合：90%债券，10%加密货币', context: '极端安全+极端投机', answer: 'antifragile', explanation: '经典杠铃：下行有上限（你最多只能损失10%），但上行无限。你从投机部分的波动中获益，同时安全部分防止毁灭。' }
];

const flashcards = [
  { category: '核心概念', q: '反脆弱的定义是什么？', a: '<strong>从冲击、波动、随机性、无序和压力源中获益的事物。</strong>超越韧性（抵抗冲击保持不变）——反脆弱实际上变得更好。关键测试：从随机事件中获得的上行多于下行。' },
  { category: '三元组', q: '三元组的三个元素及其神话代表是什么？', a: '<strong>脆弱=达摩克利斯</strong>（剑悬一线——一击毁灭）。<strong>强韧=凤凰</strong>（涅槃重生不变）。<strong>反脆弱=九头蛇</strong>（砍一头长两头——从伤害中获益）。' },
  { category: '策略', q: '什么是杠铃策略？', a: '将<strong>极端安全与极端风险</strong>结合，避开中间地带。例：90%超安全资产+10%高投机赌注。下行有限且已知；上行无限。适用于职业、投资、阅读、社交。' },
  { category: '伦理', q: '什么是风险共担？', a: '决策者必须<strong>承担后果</strong>。伦理规则：永远不要将脆弱性转嫁给他人。汉谟拉比的解决方案：房屋倒塌则建造者赴死。被银行家、官僚和学者违反——获取上行而无下行。' },
  { category: '否定法', q: '什么是林迪效应？', a: '对<strong>非易逝事物</strong>（理念、技术、书籍），预期寿命<strong>随年龄增加</strong>。一本印刷100年的书可能再持续100年。与生物衰老相反。时间是强韧性的终极过滤器。' },
  { category: '数学', q: '凸性与反脆弱性有何关系？', a: '<strong>凸性收益</strong>从正面冲击获得的多于从负面冲击失去的——这就是反脆弱性的数学表达。凹性收益则相反（脆弱）。测试："这是否从结果的方差中获益？"詹森不等式将此形式化。' },
  { category: '干预', q: '什么是医源性伤害？', a: '<strong>治疗者造成的伤害。</strong>治疗造成的损害超过原始病情。从医学延伸到经济（央行干预）、教育（过度安排）和政治（政权更迭）。首要原则：不要造成伤害。' },
  { category: '认识论', q: '什么是绿色木材谬误？', a: '混淆<strong>重要知识的来源</strong>与无关知识。一个交易员靠绿色木材赚了数百万，却以为它是涂了绿漆的——他的优势是实践市场直觉，而非产品知识。理论流畅≠实践能力。' },
  { category: '风险', q: '什么是火鸡问题？', a: '一只被喂了1000天的火鸡"确认"人类是善意的——直到<strong>感恩节</strong>。复杂系统中过去的稳定隐藏着灾难性风险。火鸡无法从数据集中计算感恩节。长期稳定往往是最危险的信号。' },
  { category: '生物学', q: '什么是毒物兴奋效应？', a: '<strong>少量有害物质或压力源对有机体有益</strong>。运动撕裂肌肉→它们变得更强。断食给细胞施压→它们修复更高效。剂量决定良药。生物层面的反脆弱性。' },
  { category: '创新', q: '什么是苏联-哈佛错觉？', a: '相信<strong>自上而下的定向研究驱动创新</strong>。实际上大多数突破来自自下而上的试验和试错。学术界随后窃取功劳——"教鸟儿飞"。' },
  { category: '系统', q: '为什么规模导致脆弱化？', a: '更大的实体对冲击<strong>更凹</strong>：一块大石头造成的伤害不成比例地超过1000颗等重小石子。更大的组织、银行和政府有更多隐藏的脆弱性。小+分散 > 大+集中。' },
  { category: '否定法', q: '什么是否定法？', a: '<strong>减法优于加法</strong>的力量。知道该去除什么比知道该添加什么更强韧。戒烟>添加保健品。去除糖>添加超级食品。消除坏政策>添加新项目。否定知识更强韧。' },
  { category: '策略', q: '什么是理性漫游者？', a: '<strong>追随可选择性而非固定计划</strong>的人。像一个根据有趣事物改变方向的步行者，理性漫游者利用意外机会而非遵循固定行程。反旅游者，反目的论。' },
  { category: '核心概念', q: '什么是领域依赖性？', a: '<strong>无法在领域间转移知识</strong>。理解健身中反脆弱性的人（肌肉从压力中成长）可能无法将其应用于商业或教育。一个领域的智能不保证另一个领域也如此。' },
  { category: '系统', q: '"压力源即信息"是什么意思？', a: '在有机/复杂系统中，<strong>压力源提供关于需要加强什么的信号</strong>。移除压力源就是移除信息——系统对威胁变得盲目。这就是为什么过度保护（旅游化）是危险的。' }
];

const quizQuestions = [
  { q: '根据塔勒布的观点，强韧与反脆弱的根本区别是什么？', options: ['强韧是自然的而反脆弱是人造的', '强韧抵抗冲击保持不变；反脆弱从冲击中变得更好', '强韧比反脆弱更强', '反脆弱只是强韧的更极端形式'], correct: 1, explanation: '这是核心区别。强韧意味着抵抗并保持不变（凤凰）。反脆弱意味着实际上从冲击中改善（九头蛇）。它们是对波动的质性不同的反应，而非同一事物的程度差异。' },
  { q: '为什么塔勒布认为出租车司机的收入比企业员工更反脆弱？', options: ['出租车司机平均赚更多', '日收入波动防止了灾难性的单点故障', '出租车司机有更好的福利', '企业员工更努力工作'], correct: 1, explanation: '出租车司机每天面临许多小压力源（变化的收入），这创造了适应性并防止了隐藏脆弱性的积累。企业员工看似稳定但面临火鸡问题式的脆弱性：一次裁员就是灾难性的。每日小随机性>隐藏的大风险。' },
  { q: '在杠铃策略的背景下，为什么应该避免"中间地带"？', options: ['中等风险头寸更难管理', '中间地带创造安全幻觉，既不能防止毁灭也没有无限上行', '极端头寸总是更有利可图', '中间地带太昂贵'], correct: 1, explanation: '中间地带给你虚假的安全感。你既得不到超安全端的确定保护，也得不到投机端的不对称上行。杠铃限制了已知下行同时保留无限上行——中间地带两者都做不好。' },
  { q: '火鸡问题与普通风险评估有什么根本不同？', options: ['火鸡比其他风险更难建模', '火鸡的整个数据集主动确认了错误模型——更多数据使它更错', '它只适用于金融市场', '它可以用更好的统计方法解决'], correct: 1, explanation: '火鸡问题不是关于数据不足——而是关于结构性误导的数据。每天的喂食都确认了火鸡关于善意人类的模型。灾难性风险（感恩节）对数据集不可见。更多数据使火鸡更自信，而不是更不错误。' },
  { q: '根据本书，什么是"苏联-哈佛错觉"？', options: ['共产主义和资本主义教育体系是等价的', '定向的自上而下研究驱动创新，而实际上是自下而上的试验', '哈佛毕业生比平均水平更聪明', '苏联有更好的技术'], correct: 1, explanation: '塔勒布认为大多数技术创新来自实践者的试验（自下而上的试错），而非定向的学术研究（自上而下）。错觉是正式研究驱动进步。实际上，学术界经常解释实践者已经发现的东西——"教鸟儿飞"。' },
  { q: '詹森不等式与脆弱性有何关系？', options: ['它衡量导致社会脆弱性的收入不平等', '如果收益是凹性的，波动下的期望结果比稳定下的结果更差——数学证明了脆弱性', '它表明平均值总是具有误导性', '它预测黑天鹅何时发生'], correct: 1, explanation: '詹森不等式是塔勒布的"点石成金术"。对凹性（脆弱）函数，波动下的平均结果比平均值的结果更差。对凸性（反脆弱）函数，更好。这数学证明了为什么脆弱的事物被不确定性伤害而反脆弱的事物从中获益。' },
  { q: '塔勒布为什么说"规模导致脆弱化"？', options: ['大公司有更多员工需要管理', '更大的实体对冲击更凹——大石头造成的伤害不成比例地超过许多石子', '小企业总是比大企业好', '政府监管更多地针对大公司'], correct: 1, explanation: '脆弱性是非线性的。一块100磅的石头造成的伤害远超100颗1磅石子。同样，一家大银行的倒闭比许多小银行倒闭造成不成比例的更大伤害。规模的集中创造了对冲击的凹性（脆弱性）。' },
  { q: '塔勒布从反脆弱理论中推导出什么伦理原则？', options: ['始终最大化自己的反脆弱性，不管对他人的影响', '不可以牺牲他人的脆弱性来换取自己的反脆弱性', '最强者应该领导因为他们最反脆弱', '伦理在复杂系统中无关紧要'], correct: 1, explanation: '核心伦理规则。那些从波动中获益同时让他人承受下行的人（银行家获得奖金而纳税人吸收损失）违反了这一原则。汉谟拉比法典体现了它：建造者如果房屋杀死屋主就要赴死。风险共担对齐了激励。' },
  { q: '塔勒布为什么偏好否定法（减法）而非添加新方案？', options: ['减法总是更便宜', '去除负面是比添加正面更强韧的知识——我们对什么伤害我们知道得比什么帮助我们更可靠', '加法总是错误的', '极简主义在美学上更优越'], correct: 1, explanation: '我们对"吸烟致死"的了解比"补品X有帮助"更可靠。减法知识（避免什么）比加法知识（做什么）更强韧。去除有害事物（坏食物、坏政策、坏习惯）比添加新干预有更可靠的正面效果，后者携带医源性风险。' },
  { q: '在塔勒布的框架中，对无法预测罕见事件的正确回应是什么？', options: ['建立更好的预测模型', '专注于测量脆弱性而非预测事件——脆弱性在风险不可测时是可测的', '避免所有风险活动', '接受我们对不确定性无能为力'], correct: 1, explanation: '这是核心方法论洞察。我们无法预测黑天鹅，但我们可以测量某物是否脆弱（会被它们伤害）或反脆弱（会从中获益）。从预测转向准备：减少脆弱性，增加反脆弱性，确保风险共担。' }
];

// =============== STATE ===============

let currentSection = 'hero';
let classifierIndex = 0;
let classifierScore = 0;
let classifierTotal = 0;
let flashcardIndex = 0;
let quizIndex = 0;
let quizScore = 0;
let quizAnswered = [];
let shuffledScenarios = [];
let shuffledFlashcards = [];
let shuffledQuiz = [];
let chapterFilter = 'all';

function loadProgress() {
  const data = JSON.parse(localStorage.getItem('antifragile_zh_progress') || '{}');
  return {
    classifierCorrect: data.classifierCorrect || 0,
    classifierTotal: data.classifierTotal || 0,
    flashcardsReviewed: data.flashcardsReviewed || 0,
    flashcardsEasy: data.flashcardsEasy || 0,
    flashcardsHard: data.flashcardsHard || 0,
    quizzesTaken: data.quizzesTaken || 0,
    quizCorrect: data.quizCorrect || 0,
    quizTotal: data.quizTotal || 0,
    conceptsViewed: data.conceptsViewed || [],
    chaptersViewed: data.chaptersViewed || []
  };
}

function saveProgress(data) {
  localStorage.setItem('antifragile_zh_progress', JSON.stringify(data));
}

function shuffle(arr) {
  const a = [...arr];
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

// =============== RENDERING ===============

function showSection(id) {
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.getElementById(id + '-section').classList.add('active');
  document.querySelectorAll('.nav-tab').forEach((t, i) => {
    const sections = ['hero', 'map', 'concepts', 'classifier', 'flashcards', 'quiz', 'progress'];
    t.classList.toggle('active', sections[i] === id);
  });
  currentSection = id;
  window.scrollTo({ top: 0, behavior: 'smooth' });
  if (id === 'map') renderBookMap();
  if (id === 'concepts') renderConcepts();
  if (id === 'classifier') initClassifier();
  if (id === 'flashcards') initFlashcards();
  if (id === 'quiz') initQuiz();
  if (id === 'progress') renderProgress();
  updateProgressBar();
}

function updateProgressBar() {
  const p = loadProgress();
  const total = concepts.length + flashcards.length + quizQuestions.length + scenarios.length;
  const done = p.conceptsViewed.length + p.flashcardsReviewed + p.quizTotal + p.classifierTotal;
  const pct = Math.min(100, (done / total) * 100);
  document.getElementById('progressBar').style.width = pct + '%';
}

// BOOK MAP
function renderBookMap() {
  const container = document.getElementById('bookMapContent');
  container.innerHTML = '';
  const grid = document.createElement('div');
  grid.className = 'book-grid';
  books.forEach((book, i) => {
    const mustCount = book.chapters.filter(c => c.priority === 'must-read').length;
    const optCount = book.chapters.filter(c => c.priority === 'optional').length;
    const card = document.createElement('div');
    card.className = 'book-card';
    card.innerHTML = `
      <div class="book-card-num">${book.num}</div>
      <div class="book-card-label">卷 ${book.num}</div>
      <div class="book-card-title">${book.title}</div>
      <div class="book-card-desc">${book.desc}</div>
      <div class="book-card-chapters">
        ${book.chapters.map(c => `<span class="chapter-tag">第${c.num}章</span>`).join('')}
      </div>
      <div class="book-card-meta">
        <span class="meta-must">&#10038; 必读 ${mustCount}</span>
        <span class="meta-optional">&#9672; 选读 ${optCount}</span>
      </div>
    `;
    card.onclick = () => {
      grid.style.display = 'none';
      renderChapterDetail(book, container, grid);
    };
    grid.appendChild(card);
  });
  container.appendChild(grid);
}

function renderChapterDetail(book, container, grid) {
  let detail = document.getElementById('chapterDetailView');
  if (detail) detail.remove();
  detail = document.createElement('div');
  detail.id = 'chapterDetailView';

  const backBtn = document.createElement('button');
  backBtn.className = 'next-btn';
  backBtn.style.marginBottom = '32px';
  backBtn.textContent = '\u2190 返回总览';
  backBtn.onclick = () => { detail.remove(); grid.style.display = 'grid'; };
  detail.appendChild(backBtn);

  const header = document.createElement('div');
  header.style.marginBottom = '32px';
  header.innerHTML = `
    <div class="section-label">卷 ${book.num}</div>
    <h2 class="section-title" style="font-size:32px">${book.title}</h2>
    <p class="section-desc">${book.desc}</p>
  `;
  detail.appendChild(header);

  // Filter bar
  const filterBar = document.createElement('div');
  filterBar.className = 'chapter-filter';
  filterBar.innerHTML = `
    <button class="chapter-filter-btn ${chapterFilter === 'all' ? 'active' : ''}" onclick="setChapterFilter('all', ${JSON.stringify(book.num).replace(/"/g, '&quot;')})">全部</button>
    <button class="chapter-filter-btn ${chapterFilter === 'must-read' ? 'active' : ''}" onclick="setChapterFilter('must-read', ${JSON.stringify(book.num).replace(/"/g, '&quot;')})">仅必读</button>
    <button class="chapter-filter-btn ${chapterFilter === 'optional' ? 'active' : ''}" onclick="setChapterFilter('optional', ${JSON.stringify(book.num).replace(/"/g, '&quot;')})">仅选读</button>
  `;
  detail.appendChild(filterBar);

  const chaptersContainer = document.createElement('div');
  chaptersContainer.id = 'chaptersContainer';

  book.chapters.forEach(ch => {
    if (chapterFilter !== 'all' && ch.priority !== chapterFilter) return;
    const chDiv = document.createElement('div');
    chDiv.className = 'chapter-detail';
    const priorityLabel = ch.priority === 'must-read' ? '必读' : '选读';
    chDiv.innerHTML = `
      <div class="chapter-detail-header">
        <span class="chapter-num">第${ch.num}章</span>
        <span class="chapter-priority ${ch.priority}">${priorityLabel}</span>
        <div style="flex:1">
          <span class="chapter-detail-title">${ch.title}</span>
          <div class="chapter-oneliner">${ch.oneliner}</div>
        </div>
        <span class="chapter-toggle">+</span>
      </div>
      <div class="chapter-detail-body">
        <div class="chapter-detail-content">
          <p>${ch.summary}</p>
          <div class="key-ideas">
            <h4>核心概念</h4>
            ${ch.ideas.map(i => `<span class="idea-chip">${i}</span>`).join('')}
          </div>
          <a href="chapters/ch${String(ch.num).padStart(2, '0')}.html" class="next-btn" style="display:inline-block;margin-top:20px;text-decoration:none;">深入阅读 →</a>
        </div>
      </div>
    `;
    chDiv.querySelector('.chapter-detail-header').onclick = () => {
      chDiv.classList.toggle('open');
      const p = loadProgress();
      if (!p.chaptersViewed.includes(ch.num)) {
        p.chaptersViewed.push(ch.num);
        saveProgress(p);
      }
    };
    chaptersContainer.appendChild(chDiv);
  });

  detail.appendChild(chaptersContainer);
  container.appendChild(detail);
}

// Store current book for filter changes
let currentFilterBook = null;
function setChapterFilter(filter, bookNum) {
  chapterFilter = filter;
  const book = books.find(b => b.num === bookNum);
  if (!book) return;
  const container = document.getElementById('bookMapContent');
  const grid = container.querySelector('.book-grid');
  const detail = document.getElementById('chapterDetailView');
  if (detail) detail.remove();
  renderChapterDetail(book, container, grid || document.createElement('div'));
}

// CONCEPTS
function renderConcepts() {
  const grid = document.getElementById('conceptsGrid');
  grid.innerHTML = '';
  concepts.forEach(c => {
    const card = document.createElement('div');
    card.className = 'concept-card';
    const badgeLabels = { meta: '元概念', fragile: '脆弱', robust: '强韧', antifragile: '反脆弱' };
    card.innerHTML = `
      <span class="triad-badge ${c.badge}">${badgeLabels[c.badge] || c.badge}</span>
      <h3>${c.name}</h3>
      <p>${c.short}</p>
      <div class="concept-example"><em>示例：</em> ${c.example}</div>
    `;
    card.onclick = () => openConceptModal(c);
    grid.appendChild(card);
  });
}

function openConceptModal(c) {
  const overlay = document.getElementById('modalOverlay');
  const content = document.getElementById('modalContent');
  const badgeLabels = { meta: '元概念', fragile: '脆弱', robust: '强韧', antifragile: '反脆弱' };
  content.innerHTML = `
    <button class="modal-close" onclick="closeModal()">&times;</button>
    <span class="triad-badge ${c.badge}" style="margin-bottom:16px;display:inline-block">${badgeLabels[c.badge] || c.badge}</span>
    <h2>${c.name}</h2>
    <div class="modal-subtitle">《反脆弱》核心概念</div>
    <p>${c.detail}</p>
    <blockquote>${c.quote}</blockquote>
    <div class="related-concepts">
      <h4>相关概念</h4>
      ${c.related.map(r => {
        const rel = concepts.find(x => x.id === r);
        return rel ? `<span class="related-tag" onclick="openConceptModal(concepts.find(x=>x.id==='${r}'))">${rel.name}</span>` : '';
      }).join('')}
    </div>
  `;
  overlay.classList.add('open');
  const p = loadProgress();
  if (!p.conceptsViewed.includes(c.id)) {
    p.conceptsViewed.push(c.id);
    saveProgress(p);
  }
}

function closeModal() {
  document.getElementById('modalOverlay').classList.remove('open');
}

document.getElementById('modalOverlay').addEventListener('click', (e) => {
  if (e.target === document.getElementById('modalOverlay')) closeModal();
});

// CLASSIFIER
function initClassifier() {
  shuffledScenarios = shuffle(scenarios);
  classifierIndex = 0;
  classifierScore = 0;
  classifierTotal = 0;
  renderClassifier();
}

function renderClassifier() {
  const container = document.getElementById('classifierContainer');
  if (classifierIndex >= shuffledScenarios.length) {
    container.innerHTML = `
      <div class="quiz-results">
        <h3>本轮完成</h3>
        <div class="quiz-score">${classifierScore}/${classifierTotal}</div>
        <p>你正确分类了 ${classifierScore} / ${classifierTotal} 个场景。</p>
        <button class="restart-btn" onclick="initClassifier()">再玩一次</button>
      </div>
    `;
    return;
  }
  const s = shuffledScenarios[classifierIndex];
  container.innerHTML = `
    <div class="classifier-prompt">
      <h3>分类这个场景</h3>
      <p>它是脆弱、强韧还是反脆弱？</p>
    </div>
    <div class="classifier-scenario">
      <div class="scenario-num">场景 ${classifierIndex + 1} / ${shuffledScenarios.length}</div>
      <div class="scenario-text">${s.text}</div>
      <div class="scenario-context">${s.context}</div>
    </div>
    <div class="classifier-options">
      <button class="classify-btn fragile" onclick="classifyAnswer('fragile')">
        <div class="btn-icon">&#9876;</div>
        <div class="btn-label">脆弱</div>
        <div class="btn-desc">被冲击伤害</div>
      </button>
      <button class="classify-btn robust" onclick="classifyAnswer('robust')">
        <div class="btn-icon">&#9672;</div>
        <div class="btn-label">强韧</div>
        <div class="btn-desc">抵抗冲击</div>
      </button>
      <button class="classify-btn antifragile" onclick="classifyAnswer('antifragile')">
        <div class="btn-icon">&#10038;</div>
        <div class="btn-label">反脆弱</div>
        <div class="btn-desc">从冲击中获益</div>
      </button>
    </div>
    <div class="feedback-box" id="classifierFeedback"></div>
    <div class="classifier-controls">
      <div class="classifier-score">得分：<span>${classifierScore}</span> / ${classifierTotal}</div>
      <button class="next-btn" id="classifierNext" style="display:none" onclick="nextScenario()">下一个场景 \u2192</button>
    </div>
  `;
}

function classifyAnswer(answer) {
  const s = shuffledScenarios[classifierIndex];
  const correct = answer === s.answer;
  classifierTotal++;
  if (correct) classifierScore++;
  const p = loadProgress();
  p.classifierTotal++;
  if (correct) p.classifierCorrect++;
  saveProgress(p);
  document.querySelectorAll('.classify-btn').forEach(btn => {
    btn.style.pointerEvents = 'none';
    if (btn.classList.contains(answer)) btn.classList.add('selected');
  });
  const answerLabels = { fragile: '脆弱', robust: '强韧', antifragile: '反脆弱' };
  const fb = document.getElementById('classifierFeedback');
  fb.className = `feedback-box visible ${correct ? 'correct' : 'incorrect'}`;
  fb.innerHTML = `
    <div class="feedback-result ${correct ? 'correct' : 'incorrect'}">${correct ? '\u2713 正确' : '\u2717 错误 \u2014 答案：' + answerLabels[s.answer]}</div>
    <p>${s.explanation}</p>
  `;
  document.getElementById('classifierNext').style.display = 'inline-block';
  document.querySelector('.classifier-score').innerHTML = `得分：<span>${classifierScore}</span> / ${classifierTotal}`;
}

function nextScenario() {
  classifierIndex++;
  renderClassifier();
}

// FLASHCARDS
function initFlashcards() {
  shuffledFlashcards = shuffle(flashcards);
  flashcardIndex = 0;
  renderFlashcard();
}

function renderFlashcard() {
  const container = document.getElementById('flashcardContainer');
  if (flashcardIndex >= shuffledFlashcards.length) {
    flashcardIndex = 0;
    shuffledFlashcards = shuffle(flashcards);
  }
  const card = shuffledFlashcards[flashcardIndex];
  container.innerHTML = `
    <div class="flashcard-controls">
      <div class="flashcard-counter">卡片 <span>${flashcardIndex + 1}</span> / ${shuffledFlashcards.length}</div>
    </div>
    <div class="flashcard-wrapper">
      <div class="flashcard" id="currentFlashcard" onclick="this.classList.toggle('flipped')">
        <div class="flashcard-face flashcard-front">
          <div class="flashcard-category">${card.category}</div>
          <div class="flashcard-question">${card.q}</div>
          <div class="flashcard-hint">点击翻转查看答案</div>
        </div>
        <div class="flashcard-face flashcard-back">
          <div class="flashcard-category">答案</div>
          <div class="flashcard-answer">${card.a}</div>
        </div>
      </div>
    </div>
    <div class="flashcard-nav">
      <button class="card-nav-btn" onclick="prevFlashcard()">\u2190</button>
      <div class="difficulty-btns">
        <button class="diff-btn hard" onclick="rateFlashcard('hard')">困难</button>
        <button class="diff-btn good" onclick="rateFlashcard('good')">一般</button>
        <button class="diff-btn easy" onclick="rateFlashcard('easy')">简单</button>
      </div>
      <button class="card-nav-btn" onclick="nextFlashcard()">\u2192</button>
    </div>
  `;
}

function prevFlashcard() { flashcardIndex = Math.max(0, flashcardIndex - 1); renderFlashcard(); }
function nextFlashcard() { flashcardIndex++; renderFlashcard(); }
function rateFlashcard(difficulty) {
  const p = loadProgress();
  p.flashcardsReviewed++;
  if (difficulty === 'easy') p.flashcardsEasy++;
  if (difficulty === 'hard') p.flashcardsHard++;
  saveProgress(p);
  nextFlashcard();
}

// QUIZ
function initQuiz() {
  shuffledQuiz = shuffle(quizQuestions).slice(0, 10);
  quizIndex = 0;
  quizScore = 0;
  quizAnswered = new Array(shuffledQuiz.length).fill(null);
  renderQuiz();
}

function renderQuiz() {
  const container = document.getElementById('quizContainer');
  if (quizIndex >= shuffledQuiz.length) {
    const p = loadProgress();
    p.quizzesTaken++;
    p.quizCorrect += quizScore;
    p.quizTotal += shuffledQuiz.length;
    saveProgress(p);
    const pct = Math.round((quizScore / shuffledQuiz.length) * 100);
    container.innerHTML = `
      <div class="quiz-results">
        <h3>测验完成</h3>
        <div class="quiz-score">${pct}%</div>
        <p>你答对了 ${quizScore} / ${shuffledQuiz.length} 题。</p>
        <button class="restart-btn" onclick="initQuiz()">重新测验</button>
      </div>
    `;
    return;
  }
  const q = shuffledQuiz[quizIndex];
  const letters = ['A', 'B', 'C', 'D'];
  container.innerHTML = `
    <div class="quiz-progress">
      ${shuffledQuiz.map((_, i) => {
        let cls = '';
        if (i === quizIndex) cls = 'current';
        else if (quizAnswered[i] !== null) cls = quizAnswered[i] ? 'correct' : 'incorrect';
        return `<div class="quiz-dot ${cls}"></div>`;
      }).join('')}
    </div>
    <div class="quiz-question-card">
      <div class="quiz-q-num">第 ${quizIndex + 1} 题，共 ${shuffledQuiz.length} 题</div>
      <div class="quiz-q-text">${q.q}</div>
      <div class="quiz-options">
        ${q.options.map((opt, i) => `
          <div class="quiz-option" onclick="answerQuiz(${i})">
            <span class="option-letter">${letters[i]}</span>
            <span>${opt}</span>
          </div>
        `).join('')}
      </div>
    </div>
    <div class="quiz-explanation" id="quizExplanation">
      <p>${q.explanation}</p>
    </div>
    <div class="classifier-controls" style="margin-top:24px">
      <div></div>
      <button class="next-btn" id="quizNext" style="display:none" onclick="nextQuizQuestion()">
        ${quizIndex < shuffledQuiz.length - 1 ? '下一题 \u2192' : '查看结果 \u2192'}
      </button>
    </div>
  `;
}

function answerQuiz(idx) {
  const q = shuffledQuiz[quizIndex];
  const correct = idx === q.correct;
  if (correct) quizScore++;
  quizAnswered[quizIndex] = correct;
  document.querySelectorAll('.quiz-option').forEach((opt, i) => {
    opt.classList.add('disabled');
    if (i === q.correct) opt.classList.add('correct');
    if (i === idx && !correct) opt.classList.add('incorrect');
  });
  document.getElementById('quizExplanation').classList.add('visible');
  document.getElementById('quizNext').style.display = 'inline-block';
}

function nextQuizQuestion() { quizIndex++; renderQuiz(); }

// PROGRESS
function renderProgress() {
  const container = document.getElementById('progressContent');
  const p = loadProgress();
  const classifierPct = p.classifierTotal > 0 ? Math.round((p.classifierCorrect / p.classifierTotal) * 100) : 0;
  const quizPct = p.quizTotal > 0 ? Math.round((p.quizCorrect / p.quizTotal) * 100) : 0;
  const conceptsPct = Math.round((p.conceptsViewed.length / concepts.length) * 100);
  const chaptersPct = Math.round((p.chaptersViewed.length / 25) * 100);
  container.innerHTML = `
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-value">${p.conceptsViewed.length}/${concepts.length}</div>
        <div class="stat-label">已探索概念</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">${p.flashcardsReviewed}</div>
        <div class="stat-label">已复习卡片</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">${classifierPct}%</div>
        <div class="stat-label">三元分类准确率</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">${quizPct}%</div>
        <div class="stat-label">测验准确率</div>
      </div>
    </div>
    <div class="mastery-section">
      <h3>掌握度分析</h3>
      <div class="mastery-item">
        <span class="mastery-label">已探索概念</span>
        <div class="mastery-bar-bg"><div class="mastery-bar" style="width:${conceptsPct}%"></div></div>
        <span class="mastery-pct">${conceptsPct}%</span>
      </div>
      <div class="mastery-item">
        <span class="mastery-label">已阅读章节</span>
        <div class="mastery-bar-bg"><div class="mastery-bar" style="width:${chaptersPct}%"></div></div>
        <span class="mastery-pct">${chaptersPct}%</span>
      </div>
      <div class="mastery-item">
        <span class="mastery-label">三元分类</span>
        <div class="mastery-bar-bg"><div class="mastery-bar" style="width:${classifierPct}%"></div></div>
        <span class="mastery-pct">${classifierPct}%</span>
      </div>
      <div class="mastery-item">
        <span class="mastery-label">测验表现</span>
        <div class="mastery-bar-bg"><div class="mastery-bar" style="width:${quizPct}%"></div></div>
        <span class="mastery-pct">${quizPct}%</span>
      </div>
      <div class="mastery-item">
        <span class="mastery-label">闪卡记忆率</span>
        <div class="mastery-bar-bg"><div class="mastery-bar" style="width:${p.flashcardsReviewed > 0 ? Math.round((p.flashcardsEasy / p.flashcardsReviewed) * 100) : 0}%"></div></div>
        <span class="mastery-pct">${p.flashcardsReviewed > 0 ? Math.round((p.flashcardsEasy / p.flashcardsReviewed) * 100) : 0}%</span>
      </div>
    </div>
    <button class="next-btn" style="margin-top:16px" onclick="if(confirm('确定要重置所有进度吗？')){localStorage.removeItem('antifragile_zh_progress');renderProgress();}">重置进度</button>
  `;
}

// NAV SCROLL BEHAVIOR
let lastScroll = 0;
window.addEventListener('scroll', () => {
  const nav = document.getElementById('mainNav');
  const st = window.scrollY;
  if (st > lastScroll && st > 100) nav.classList.add('hidden');
  else nav.classList.remove('hidden');
  lastScroll = st;
});

// KEYBOARD SHORTCUTS
document.addEventListener('keydown', (e) => {
  if (currentSection === 'flashcards') {
    if (e.code === 'Space') { e.preventDefault(); const fc = document.getElementById('currentFlashcard'); if (fc) fc.classList.toggle('flipped'); }
    if (e.code === 'ArrowRight') nextFlashcard();
    if (e.code === 'ArrowLeft') prevFlashcard();
  }
});

document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeModal(); });

// INIT
updateProgressBar();
</script>
</body>
</html>
