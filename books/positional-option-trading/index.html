<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Positional Option Trading — Interactive Study Guide</title>
<meta name="description" content="An advanced guide to identifying trading edges, managing quantitative risk, and mastering the nuances of volatility and directional options strategies in professional markets.">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;0,900;1,400&family=JetBrains+Mono:wght@300;400;500&family=Source+Serif+4:ital,opsz,wght@0,8..60,300;0,8..60,400;0,8..60,600;0,8..60,700;1,8..60,400&display=swap" rel="stylesheet">
<link rel="stylesheet" href="../../css/shared.css">
<style>
  /* Book Map - Chapter Grid */
  .part-header { margin: 48px 0 24px; padding: 0 24px; }
  .part-header:first-child { margin-top: 0; }
  .part-num { font-family: 'JetBrains Mono', monospace; font-size: 13px; letter-spacing: 2px; text-transform: uppercase; color: var(--accent); margin-bottom: 8px; }
  .part-title { font-family: 'Playfair Display', serif; font-size: 28px; font-weight: 700; color: var(--text); margin-bottom: 8px; }
  .part-desc { font-size: 15px; color: var(--muted); line-height: 1.6; max-width: 640px; }

  .chapter-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; padding: 0 24px; margin-bottom: 32px; }

  .chapter-card {
    background: var(--glass);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 24px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    flex-direction: column;
  }
  .chapter-card:hover { border-color: var(--accent); transform: translateY(-2px); box-shadow: 0 8px 32px rgba(0,0,0,0.3); }

  .chapter-card-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
  .chapter-card-num { font-family: 'JetBrains Mono', monospace; font-size: 13px; color: var(--accent); font-weight: 600; }
  .chapter-priority { font-size: 11px; padding: 3px 10px; border-radius: 20px; font-weight: 500; }
  .chapter-priority.must-read { background: rgba(200,170,110,0.15); color: var(--accent); }
  .chapter-priority.optional { background: rgba(255,255,255,0.05); color: var(--muted); }

  .chapter-card-title { font-family: 'Playfair Display', serif; font-size: 18px; font-weight: 700; color: var(--text); margin-bottom: 8px; line-height: 1.3; }
  .chapter-card-oneliner { font-size: 14px; color: var(--muted); line-height: 1.5; margin-bottom: 16px; flex: 1; }

  .chapter-card-ideas { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 16px; }
  .chapter-card-ideas .idea-chip { font-size: 11px; padding: 3px 10px; border-radius: 20px; background: rgba(255,255,255,0.05); color: var(--muted); border: 1px solid var(--border); }

  .chapter-card-link { font-family: 'JetBrains Mono', monospace; font-size: 13px; color: var(--accent); text-decoration: none; transition: opacity 0.2s; }
  .chapter-card-link:hover { opacity: 0.8; }

  /* Page reference callout in chapters */
  .page-ref-callout {
    background: rgba(200,170,110,0.08);
    border-left: 3px solid var(--accent);
    border-radius: 0 8px 8px 0;
    padding: 20px 24px;
    margin: 32px 0;
    font-size: 15px;
    color: var(--muted);
    line-height: 1.6;
  }
  .page-ref-callout .page-ref-icon { font-size: 20px; margin-right: 8px; }
  .page-ref-callout strong { color: var(--text); }
</style>
</head>
<body>

<!-- NAVIGATION -->
<nav id="mainNav">
  <div class="nav-inner">
    <div class="nav-logo" onclick="showSection('hero')">Positional Option Trading</div>
    <div class="nav-tabs">
      <button class="nav-tab active" onclick="showSection('hero')"><span>Home</span></button>
      <button class="nav-tab" onclick="showSection('map')"><span>Book Map</span></button>
      <button class="nav-tab" onclick="showSection('concepts')"><span>Concepts</span></button>
      <button class="nav-tab" onclick="showSection('classifier')"><span>Classifier</span></button>
      <button class="nav-tab" onclick="showSection('flashcards')"><span>Flashcards</span></button>
      <button class="nav-tab" onclick="showSection('quiz')"><span>Quiz</span></button>
      <button class="nav-tab" onclick="showSection('progress')"><span>Progress</span></button>
    </div>
  </div>
  <div class="progress-bar" id="progressBar"></div>
</nav>

<!-- HERO -->
<section class="section active" id="hero-section">
  <div class="hero">
    <div class="hero-subtitle">MASTER THE ART OF QUANTITATIVE OPTION STRATEGIES</div>
    <h1 class="hero-title"><em>Positional</em> Option Trading</h1>
    <p class="hero-desc">An advanced guide to identifying trading edges, managing quantitative risk, and mastering the nuances of volatility and directional options strategies in professional markets.</p>
    <div class="scroll-hint" onclick="showSection('map')" style="cursor:pointer">
      <span>Start Exploring</span>
      <div class="scroll-line"></div>
    </div>
  </div>
</section>

<!-- BOOK MAP -->
<section class="section" id="map-section">
  <div class="section-header">
    <div class="section-label">Structure</div>
    <h2 class="section-title">Book Overview</h2>
    <p class="section-desc">Navigate every part and chapter of Positional Option Trading by Euan Sinclair.</p>
  </div>
  <div id="bookMapContent"></div>
</section>

<!-- CONCEPTS -->
<section class="section" id="concepts-section">
  <div class="section-header">
    <div class="section-label">Core Ideas</div>
    <h2 class="section-title">Key Concepts</h2>
    <p class="section-desc">Essential mental models and frameworks from Positional Option Trading. Click any concept to explore in depth.</p>
  </div>
  <div class="concepts-grid" id="conceptsGrid"></div>
</section>

<!-- CLASSIFIER -->
<section class="section" id="classifier-section">
  <div class="section-header">
    <div class="section-label">Interactive Exercise</div>
    <h2 class="section-title">Concept Classifier</h2>
    <p class="section-desc">Match real-world scenarios to the correct concept. Train your intuition for the book's core ideas.</p>
  </div>
  <div class="classifier-container" id="classifierContainer"></div>
</section>

<!-- FLASHCARDS -->
<section class="section" id="flashcards-section">
  <div class="section-header">
    <div class="section-label">Spaced Repetition</div>
    <h2 class="section-title">Flashcard Review</h2>
    <p class="section-desc">Review core concepts through spaced repetition. Click to flip, rate your recall.</p>
  </div>
  <div class="flashcard-container" id="flashcardContainer"></div>
</section>

<!-- QUIZ -->
<section class="section" id="quiz-section">
  <div class="section-header">
    <div class="section-label">Self-Test</div>
    <h2 class="section-title">Comprehension Quiz</h2>
    <p class="section-desc">Test your deep understanding with challenging questions. Each includes detailed explanations.</p>
  </div>
  <div class="quiz-container" id="quizContainer"></div>
</section>

<!-- PROGRESS -->
<section class="section" id="progress-section">
  <div class="section-header">
    <div class="section-label">Learning Analytics</div>
    <h2 class="section-title">Your Progress</h2>
    <p class="section-desc">Track mastery across all learning modes. Data saved in your browser.</p>
  </div>
  <div id="progressContent"></div>
</section>

<!-- MODAL -->
<div class="modal-overlay" id="modalOverlay">
  <div class="modal" id="modalContent"></div>
</div>

<script>
// =============== DATA ===============
const books = [{"num": "I", "title": "Foundations and Volatility Forecasting", "desc": "An exploration of option pricing models, market efficiency, and the critical role of forecasting realized volatility compared to market-implied expectations.", "chapters": [{"num": 1, "title": "Options and Pricing Models", "oneliner": "Models are tools for converting price to implied volatility, not absolute truths.", "summary": "This chapter introduces the Black-Scholes-Merton (BSM) model as a cornerstone of trading, emphasizing that its primary utility is providing an arbitrage-free way to communicate via implied volatility. It highlights that successful trading hinges on identifying mispriced implied volatilities rather than relying on the model's perfect accuracy.", "ideas": ["All models are wrong but some are useful", "Expected return of the underlying is irrelevant in BSM", "Profit arises from discrepancies between implied and realized volatility"], "priority": "must-read"}, {"num": 4, "title": "The Variance Premium", "oneliner": "The consistent gap where implied volatility exceeds realized volatility.", "summary": "Sinclair explains the volatility premium as a persistent phenomenon across various asset classes, driven by the demand for market insurance. Traders can find a structural edge by selling this premium, though they must manage the risks of extreme market jumps.", "ideas": ["Implied volatility is an upward-biased estimator", "Insurance demand inflates option prices", "Variance premium exists in equities, bonds, and commodities"], "priority": "must-read"}]}, {"num": "II", "title": "Strategy Selection and Risk Management", "desc": "Practical implementation of directional and volatility trades, coupled with rigorous trade sizing and the identification of non-market meta risks.", "chapters": [{"num": 9, "title": "Trade Sizing and the Kelly Criterion", "oneliner": "Maximizing long-term growth through mathematical sizing.", "summary": "This chapter focuses on the Kelly Criterion as the optimal method for trade sizing to ensure long-term wealth maximization. It discusses adjustments for non-normal returns and the importance of using fractional Kelly to manage psychological stress and parameter uncertainty.", "ideas": ["Kelly maximizes the geometric growth of the bankroll", "Positive skewness allows for larger bet sizes", "Over-betting is more dangerous than under-betting"], "priority": "must-read"}, {"num": 10, "title": "Meta Risks", "oneliner": "The dangers that exist outside of market price movements.", "summary": "Sinclair identifies external threats such as fraud, currency collapse, and institutional failure that can destroy a trader regardless of their market strategy. It emphasizes due diligence and diversification across institutions and jurisdictions.", "ideas": ["Fraud is a significant threat to professional traders", "Currency risk and hyperinflation can negate trading gains", "Separating trading and compliance functions is vital"], "priority": "optional"}]}];
const concepts = [{"id": "variance-premium", "name": "The Variance Premium", "badge": "core", "short": "The tendency for implied volatility to be higher than subsequently realized volatility.", "example": "The VIX index is historically about 4 points higher than the actual movement of the S&P 500.", "detail": "This premium exists because investors are willing to pay a 'tax' for insurance against market crashes. Option sellers collect this premium as compensation for taking on the risk of sudden, large price movements. It is a fundamental edge that persists across equities, commodities, and currencies.", "quote": "The variance premium is the tendency for implied volatility to be higher than subsequently realized volatility.", "related": ["implied-volatility", "volatility-skew"]}, {"id": "kelly-criterion", "name": "Kelly Criterion", "badge": "math", "short": "A formula used to determine the optimal size of a series of bets to maximize long-term growth.", "example": "If a trade has a 60% win rate and 1:1 payout, the Kelly fraction suggests betting 20% of your capital.", "detail": "In options trading, the Kelly Criterion helps balance the trade-off between growing the bankroll and avoiding the risk of ruin. Because options returns are often non-normal, traders must adjust the formula for skewness and uncertainty in their edge. Most professionals use 'fractional Kelly' to reduce volatility.", "quote": "The Kelly criterion... will theoretically outperform any other sizing strategy.", "related": ["trade-sizing", "meta-risks"]}, {"id": "meta-risks", "name": "Meta Risks", "badge": "risk", "short": "Risks external to the market, such as legal, governmental, or institutional failures.", "example": "A trader losing their entire capital because their broker went bankrupt or committed fraud.", "detail": "Meta risks are often ignored by amateur traders but are the primary cause of 'blow-ups' for professionals. These include currency hyperinflation, fraud (like Bernie Madoff), and sudden changes in index methodology. Managing these requires diversification of counterparties and rigorous due diligence.", "quote": "If a trader blows up because of a market move, it is due to either ignorance or overconfidence.", "related": ["kelly-criterion"]}, {"id": "implied-volatility-skew", "name": "Volatility Skew", "badge": "strategy", "short": "The difference in implied volatility between out-of-the-money puts and calls.", "example": "S&P 500 OTM puts typically have much higher IV than OTM calls due to fear of crashes.", "detail": "Skew reflects the market's demand for specific types of protection. In equity markets, 'crash-o-phobia' leads to expensive downside puts. Traders can exploit this by selling the overpriced skew, often through risk reversals or ratio spreads, provided they understand the underlying jump risk.", "quote": "The implied skewness premium arises from the tendency of out-of-the-money puts to be overpriced.", "related": ["variance-premium"]}, {"id": "efficient-market-hypothesis", "name": "Efficient Market Hypothesis (EMH)", "badge": "meta", "short": "The theory that asset prices reflect all available information, making it hard to beat the market.", "example": "A stock price instantly jumping after an earnings release, leaving no room for latecomers to profit.", "detail": "Sinclair argues that while the market is mostly efficient, it is not perfectly so. Inefficiencies arise from behavioral biases, structural constraints, and the cost of information. Successful traders find 'edges' where the EMH breaks down temporarily or due to risk premia.", "quote": "Making money is hard, but it isn't impossible.", "related": ["alpha-decay", "behavioral-finance"]}, {"id": "alpha-decay", "name": "Alpha Decay", "badge": "strategy", "short": "The process where a trading edge loses its profitability over time as more participants exploit it.", "example": "A technical pattern that worked in the 1990s becomes unprofitable as high-frequency algorithms arbitrage it away.", "detail": "Market inefficiencies have a limited lifespan. As soon as a profitable phenomenon is documented and widely known, capital flows into it, narrowing the mispricing until transaction costs exceed potential gains. This necessitates constant research and adaptation.", "quote": "Nothing lasts forever.", "related": ["efficient-market-hypothesis"]}, {"id": "delta-hedging", "name": "Delta Hedging", "badge": "strategy", "short": "Reducing the directional risk of an option position by trading the underlying asset.", "example": "Selling 50 shares of stock to hedge a long call option with a delta of 0.50.", "detail": "Delta hedging allows a trader to isolate the volatility component of an option. By neutralizing price movement exposure, the trader bets solely on whether the realized volatility will be higher or lower than the implied volatility paid for the option.", "quote": "The primary reason to hedge options is to manage exposure to volatility rather than directional price movements.", "related": ["variance-premium"]}, {"id": "rule-of-three", "name": "Rule of Three", "badge": "math", "short": "A statistical heuristic to estimate the probability of an event that hasn't happened yet.", "example": "If a strategy has never failed in 30 trials, the 95% upper bound for failure is 3/30, or 10%.", "detail": "This is a vital tool for risk management in 'tail risk' scenarios. If you haven't seen a specific disaster in a certain number of observations, the Rule of Three gives you a conservative estimate of the maximum likelihood of that disaster occurring in the next step.", "quote": "The Rule of Three assists in estimating the upper probability of an event that hasn't occurred.", "related": ["rule-of-five"]}, {"id": "execution-dilemma", "name": "The Execution Dilemma", "badge": "strategy", "short": "The trade-off between being aggressive to ensure a fill and being passive to minimize costs.", "example": "Waiting for a better price on a limit order and missing a massive market move.", "detail": "Traders must balance the cost of the bid-ask spread against the 'opportunity cost' of not getting into a trade. In high-conviction scenarios, being aggressive is often better, whereas in high-frequency, low-margin trades, passive execution is required to maintain the edge.", "quote": "Execution was such a valuable skill that being good at it could mask a lot of other trading weaknesses.", "related": ["vwap"]}, {"id": "subjective-pricing", "name": "Subjective Option Pricing", "badge": "strategy", "short": "Adjusting standard models to include a trader's personal forecast or 'drift'.", "example": "Using a higher expected return for a stock in a modified BSM model to find the 'true' value of a call.", "detail": "While BSM assumes a risk-neutral world, directional traders can introduce their own subjective estimates of the underlying's future price. This helps in selecting the optimal strike and expiration that aligns with their specific directional conviction and risk appetite.", "quote": "Traders should leverage subjective models based on unique market forecasts.", "related": ["efficient-market-hypothesis"]}];
const scenarios = [{"text": "An options trader notices that the 30-day implied volatility of the S&P 500 is 20%, but the historical realized volatility has averaged only 16%. They decide to sell straddles.", "context": "Market Observation", "answer": "variance-premium", "explanation": "The trader is exploiting the consistent gap where IV exceeds realized volatility, which is the definition of the variance premium."}, {"text": "A trader identifies a strategy with a positive expected value. They calculate their bet size to ensure they don't go bust during a losing streak while maximizing long-term wealth.", "context": "Risk Management", "answer": "kelly-criterion", "explanation": "The Kelly Criterion is the specific mathematical framework used to determine optimal bet sizing for long-term growth."}, {"text": "A fund manager spreads their capital across four different prime brokers and three different jurisdictions to ensure a single legal or institutional failure doesn't end their business.", "context": "Strategic Planning", "answer": "meta-risks", "explanation": "This is a mitigation strategy for Meta Risks, which involve non-market threats like institutional insolvency or fraud."}, {"text": "A trader wants to buy protection for their portfolio. They notice that the 10% OTM puts are significantly more expensive than the 10% OTM calls.", "context": "Pricing Analysis", "answer": "implied-volatility-skew", "explanation": "The disparity in IV between puts and calls at different strikes is known as the volatility skew."}, {"text": "A quantitative researcher finds a profitable pattern in 2015, but by 2023, the same pattern consistently loses money after transaction costs.", "context": "Strategy Lifecycle", "answer": "alpha-decay", "explanation": "This represents alpha decay, where market efficiency increases as more participants exploit a known edge."}, {"text": "A trader buys a call option because they are bullish, but they immediately sell a specific amount of the underlying stock to remove the effect of small price changes.", "context": "Hedging", "answer": "delta-hedging", "explanation": "The trader is delta-hedging to neutralize directional risk and focus purely on the volatility or other Greeks."}, {"text": "A firm has executed 100 trades without a single clearing error. They want to know the maximum statistical likelihood that the next trade will have an error.", "context": "Probability Estimation", "answer": "rule-of-three", "explanation": "The Rule of Three provides a 95% upper bound for the probability of an event that has not yet occurred in the sample."}, {"text": "A trader is trying to decide whether to hit the 'bid' immediately or wait for a mid-price fill while the market is moving rapidly against them.", "context": "Trade Execution", "answer": "execution-dilemma", "explanation": "This is the classic execution dilemma of balancing transaction costs against the risk of missing the trade."}, {"text": "A trader believes a stock will rise 15% over the next month, so they use a modified pricing model that incorporates this 'drift' to find undervalued calls.", "context": "Directional Betting", "answer": "subjective-pricing", "explanation": "This is subjective option pricing, where personal forecasts are integrated into the valuation model."}, {"text": "A trader realizes that despite their discipline, they are losing money because the market has already priced in the information they are using.", "context": "Theory of Markets", "answer": "efficient-market-hypothesis", "explanation": "The Efficient Market Hypothesis suggests that if information is public, it's already in the price, leaving no edge for the trader."}];
const flashcards = [{"category": "Pricing", "q": "What is the primary variable the BSM model solves for in practice?", "a": "<strong>Implied Volatility</strong>."}, {"category": "Risk", "q": "What is the difference between a Straddle and a Strangle?", "a": "A Straddle uses the <strong>same strike</strong> for both options; a Strangle uses <strong>different strikes</strong>."}, {"category": "Math", "q": "What does 'Full Kelly' sizing maximize?", "a": "The <strong>expected logarithm</strong> of wealth (long-term growth)."}, {"category": "Risk", "q": "What are the three main components of 'Meta Risk'?", "a": "<strong>Moral</strong> (fraud), <strong>Legal/Governmental</strong>, and <strong>Institutional/Currency</strong> risks."}, {"category": "Strategy", "q": "What is 'Contango' in the context of VIX futures?", "a": "When <strong>futures prices are higher</strong> than the current spot (cash) price."}, {"category": "Greeks", "q": "What does Gamma measure?", "a": "The <strong>rate of change of Delta</strong> relative to the underlying price."}, {"category": "Greeks", "q": "What does Theta represent?", "a": "The <strong>time decay</strong> of an option's value."}, {"category": "Strategy", "q": "Why is selling short-dated options usually more profitable?", "a": "They often carry the <strong>highest variance premium</strong> relative to their risk."}, {"category": "Math", "q": "What is the 'Rule of Five'?", "a": "A heuristic stating there is a 93% chance the <strong>median</strong> of a population lies between the smallest and largest of 5 random samples."}, {"category": "Execution", "q": "What does VWAP stand for?", "a": "<strong>Volume Weighted Average Price</strong>."}, {"category": "Behavioral", "q": "How does 'Crowding' affect a convergence strategy?", "a": "It can <strong>stabilize</strong> the market and help realize profits as prices move toward the target."}, {"category": "Behavioral", "q": "How does 'Crowding' affect a divergence (trend) strategy?", "a": "It can lead to <strong>bubbles and crashes</strong> due to destabilizing feedback loops."}, {"category": "Theory", "q": "Does the BSM model require the expected return of a stock?", "a": "<strong>No</strong>, it assumes a risk-neutral world where only volatility matters."}, {"category": "Strategy", "q": "What is a 'Risk Reversal'?", "a": "Selling an OTM put and buying an OTM call (or vice versa) to <strong>bet on direction and skew</strong>."}, {"category": "Risk", "q": "What is 'Alpha Decay'?", "a": "The <strong>diminishing profitability</strong> of a trading edge over time."}, {"category": "Pricing", "q": "What is the 'Volatility Smile'?", "a": "The pattern where <strong>OTM options have higher IV</strong> than ATM options, contradicting BSM assumptions."}];
const quizQuestions = [{"q": "According to Sinclair, what is the primary reason the Variance Premium exists?", "options": ["Market makers are greedy", "Investors pay a premium for insurance/protection", "Interest rates are too low", "The Black-Scholes model is mathematically broken"], "correct": 1, "explanation": "The premium is largely driven by the structural demand for downside protection, for which investors are willing to pay more than the statistical fair value."}, {"q": "What happens to the optimal Kelly bet size if a trade has positive skewness?", "options": ["It decreases", "It stays the same", "It increases", "Skewness has no effect on Kelly"], "correct": 2, "explanation": "Positive skewness (the potential for large 'lottery-like' wins) increases the optimal fraction to bet because it improves the growth-to-risk ratio."}, {"q": "Which form of the Efficient Market Hypothesis states that only past price information is reflected in current prices?", "options": ["Strong EMH", "Semi-Strong EMH", "Weak EMH", "Non-efficient EMH"], "correct": 2, "explanation": "The Weak EMH focuses specifically on historical price data and suggests technical analysis cannot provide an edge."}, {"q": "Why is 'Full Kelly' sizing considered dangerous for most human traders?", "options": ["It results in too many small trades", "It causes extreme volatility and large drawdowns", "It is illegal in most jurisdictions", "It only works for stocks, not options"], "correct": 1, "explanation": "Strict adherence to Full Kelly leads to very large swings in bankroll that are psychologically difficult to handle and sensitive to estimation errors."}, {"q": "In a 'Contango' market for VIX futures, what is the typical profitable strategy?", "options": ["Buying VIX futures", "Shorting VIX futures", "Buying the S&P 500 cash index", "Buying OTM calls on the VIX"], "correct": 1, "explanation": "In contango, the futures price is higher than the spot price and tends to decay toward the spot as expiration approaches, favoring short sellers."}, {"q": "What is the 'Rule of Three' used to estimate?", "options": ["The number of trades needed to be profitable", "The upper bound probability of an event that hasn't happened", "The three Greeks that matter most", "The three levels of market efficiency"], "correct": 1, "explanation": "It provides a simple statistical way to place a 95% confidence ceiling on the probability of rare failures or events."}, {"q": "What is the main drawback of 'Delta Hedging' an option position?", "options": ["It increases directional risk", "It increases transaction costs and complexity", "It removes the volatility premium", "It makes Gamma zero"], "correct": 1, "explanation": "Frequent hedging incurs significant commissions and bid-ask spread costs, which can eat into the profits generated by the volatility edge."}, {"q": "Which strategy involves selling an ATM put and buying an OTM put?", "options": ["Long Call Spread", "Short Put Spread", "Risk Reversal", "Iron Condor"], "correct": 1, "explanation": "A Short Put Spread involves selling a put at a higher strike and buying one at a lower strike to limit risk."}, {"q": "What does the BSM model assume about the distribution of asset returns?", "options": ["They are uniformly distributed", "They are normally distributed", "They follow a power law", "They are completely random and non-measurable"], "correct": 1, "explanation": "BSM assumes a normal (log-normal for prices) distribution, which is a key simplification that leads to the 'volatility smile' when reality proves to have fatter tails."}, {"q": "What is 'Opportunity Cost' in trade execution?", "options": ["The cost of the broker's commission", "Lost profits from a trade that was never filled", "The taxes paid on winning trades", "The interest lost on cash held in the account"], "correct": 1, "explanation": "Opportunity cost occurs when a trader tries to save on the spread but the market moves away, leaving the trade unexecuted and the potential profit lost."}];
const STORAGE_KEY = 'positional-option-trading_progress';

// =============== STATE ===============
let currentSection = 'hero';
let classifierIndex = 0;
let classifierScore = 0;
let classifierTotal = 0;
let flashcardIndex = 0;
let quizIndex = 0;
let quizScore = 0;
let quizAnswered = [];
let shuffledScenarios = [];
let shuffledFlashcards = [];
let shuffledQuiz = [];
let chapterFilter = 'all';

function loadProgress() {
  const data = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
  return {
    classifierCorrect: data.classifierCorrect || 0,
    classifierTotal: data.classifierTotal || 0,
    flashcardsReviewed: data.flashcardsReviewed || 0,
    flashcardsEasy: data.flashcardsEasy || 0,
    flashcardsHard: data.flashcardsHard || 0,
    quizzesTaken: data.quizzesTaken || 0,
    quizCorrect: data.quizCorrect || 0,
    quizTotal: data.quizTotal || 0,
    conceptsViewed: data.conceptsViewed || [],
    chaptersViewed: data.chaptersViewed || []
  };
}

function saveProgress(data) { localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); }

function shuffle(arr) {
  const a = [...arr];
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

// =============== RENDERING ===============
function showSection(id) {
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.getElementById(id + '-section').classList.add('active');
  document.querySelectorAll('.nav-tab').forEach((t, i) => {
    const sections = ['hero', 'map', 'concepts', 'classifier', 'flashcards', 'quiz', 'progress'];
    t.classList.toggle('active', sections[i] === id);
  });
  currentSection = id;
  window.scrollTo({ top: 0, behavior: 'smooth' });
  if (id === 'map') renderBookMap();
  if (id === 'concepts') renderConcepts();
  if (id === 'classifier') initClassifier();
  if (id === 'flashcards') initFlashcards();
  if (id === 'quiz') initQuiz();
  if (id === 'progress') renderProgress();
  updateProgressBar();
}

function updateProgressBar() {
  const p = loadProgress();
  const total = concepts.length + flashcards.length + quizQuestions.length + scenarios.length;
  const done = p.conceptsViewed.length + p.flashcardsReviewed + p.quizTotal + p.classifierTotal;
  const pct = Math.min(100, (done / total) * 100);
  document.getElementById('progressBar').style.width = pct + '%';
}

// BOOK MAP
function renderBookMap() {
  const container = document.getElementById('bookMapContent');
  container.innerHTML = '';

  books.forEach((book) => {
    // Part header
    const partHeader = document.createElement('div');
    partHeader.className = 'part-header';
    partHeader.innerHTML = `
      <div class="part-num">Part ${book.num}</div>
      <div class="part-title">${book.title}</div>
      <div class="part-desc">${book.desc}</div>
    `;
    container.appendChild(partHeader);

    // Chapter cards grid
    const grid = document.createElement('div');
    grid.className = 'chapter-grid';

    book.chapters.forEach(ch => {
      const card = document.createElement('div');
      card.className = 'chapter-card';
      const priorityLabel = ch.priority === 'must-read' ? '★ Must-read' : '◇ Optional';
      const priorityClass = ch.priority === 'must-read' ? 'must-read' : 'optional';
      card.innerHTML = `
        <div class="chapter-card-top">
          <span class="chapter-card-num">Ch ${ch.num}</span>
          <span class="chapter-priority ${priorityClass}">${priorityLabel}</span>
        </div>
        <div class="chapter-card-title">${ch.title}</div>
        <div class="chapter-card-oneliner">${ch.oneliner}</div>
        <div class="chapter-card-ideas">
          ${ch.ideas.map(i => `<span class="idea-chip">${i}</span>`).join('')}
        </div>
        <a href="chapters/ch${String(ch.num).padStart(2, '0')}.html" class="chapter-card-link">Deep Dive →</a>
      `;
      card.addEventListener('click', (e) => {
        if (e.target.tagName === 'A') return;
        card.classList.toggle('expanded');
        const p = loadProgress();
        if (!p.chaptersViewed.includes(ch.num)) { p.chaptersViewed.push(ch.num); saveProgress(p); }
      });
      grid.appendChild(card);
    });

    container.appendChild(grid);
  });
}

// CONCEPTS
function renderConcepts() {
  const grid = document.getElementById('conceptsGrid');
  grid.innerHTML = '';
  concepts.forEach(c => {
    const card = document.createElement('div');
    card.className = 'concept-card';
    card.innerHTML = `
      <span class="triad-badge ${c.badge}">${c.badge}</span>
      <h3>${c.name}</h3>
      <p>${c.short}</p>
      <div class="concept-example"><em>Example:</em> ${c.example}</div>
    `;
    card.onclick = () => openConceptModal(c);
    grid.appendChild(card);
  });
}

function openConceptModal(c) {
  const overlay = document.getElementById('modalOverlay');
  const content = document.getElementById('modalContent');
  content.innerHTML = `
    <button class="modal-close" onclick="closeModal()">&times;</button>
    <span class="triad-badge ${c.badge}" style="margin-bottom:16px;display:inline-block">${c.badge}</span>
    <h2>${c.name}</h2>
    <div class="modal-subtitle">Core Concept</div>
    <p>${c.detail}</p>
    <blockquote>${c.quote}</blockquote>
    <div class="related-concepts">
      <h4>Related Concepts</h4>
      ${(c.related || []).map(r => {
        const rel = concepts.find(x => x.id === r);
        return rel ? `<span class="related-tag" onclick="openConceptModal(concepts.find(x=>x.id==='${r}'))">${rel.name}</span>` : '';
      }).join('')}
    </div>
  `;
  overlay.classList.add('open');
  const p = loadProgress();
  if (!p.conceptsViewed.includes(c.id)) { p.conceptsViewed.push(c.id); saveProgress(p); }
}

function closeModal() { document.getElementById('modalOverlay').classList.remove('open'); }
document.getElementById('modalOverlay').addEventListener('click', e => { if (e.target === document.getElementById('modalOverlay')) closeModal(); });

// CLASSIFIER
function initClassifier() {
  shuffledScenarios = shuffle(scenarios);
  classifierIndex = 0; classifierScore = 0; classifierTotal = 0;
  renderClassifier();
}

function renderClassifier() {
  const container = document.getElementById('classifierContainer');
  if (classifierIndex >= shuffledScenarios.length) {
    container.innerHTML = `<div class="quiz-results"><h3>Round Complete</h3><div class="quiz-score">${classifierScore}/${classifierTotal}</div><p>You correctly classified ${classifierScore} / ${classifierTotal} scenarios.</p><button class="restart-btn" onclick="initClassifier()">Play Again</button></div>`;
    return;
  }
  const s = shuffledScenarios[classifierIndex];
  // Build concept buttons from unique badges
  const badges = [...new Set(concepts.map(c => c.badge))].slice(0, 4);
  const badgeButtons = concepts.slice(0, 3).map(c => `
    <button class="classify-btn ${c.badge}" onclick="classifyAnswer('${c.id}')">
      <div class="btn-label">${c.name}</div>
      <div class="btn-desc">${c.short.substring(0, 50)}…</div>
    </button>
  `).join('');
  
  container.innerHTML = `
    <div class="classifier-prompt">
      <h3>Identify the Concept</h3>
      <p>Which concept best explains this scenario?</p>
    </div>
    <div class="classifier-scenario">
      <div class="scenario-num">Scenario ${classifierIndex + 1} / ${shuffledScenarios.length}</div>
      <div class="scenario-text">${s.text}</div>
      <div class="scenario-context">${s.context}</div>
    </div>
    <div class="classifier-options">
      ${shuffledScenarios[classifierIndex] ? getClassifierOptions(s) : ''}
    </div>
    <div class="feedback-box" id="classifierFeedback"></div>
    <div class="classifier-controls">
      <div class="classifier-score">Score: <span>${classifierScore}</span> / ${classifierTotal}</div>
      <button class="next-btn" id="classifierNext" style="display:none" onclick="nextScenario()">Next Scenario \u2192</button>
    </div>
  `;
}

function getClassifierOptions(scenario) {
  const correct = concepts.find(c => c.id === scenario.answer);
  if (!correct) return '';
  let options = [correct];
  const others = concepts.filter(c => c.id !== scenario.answer);
  const shuffled = shuffle(others).slice(0, 2);
  options = shuffle([...options, ...shuffled]);
  return options.map(c => `
    <button class="classify-btn ${c.badge}" onclick="classifyAnswer('${c.id}')">
      <div class="btn-label">${c.name}</div>
      <div class="btn-desc">${c.short.substring(0, 60)}…</div>
    </button>
  `).join('');
}

function classifyAnswer(answer) {
  const s = shuffledScenarios[classifierIndex];
  const correct = answer === s.answer;
  classifierTotal++;
  if (correct) classifierScore++;
  const p = loadProgress();
  p.classifierTotal++; if (correct) p.classifierCorrect++;
  saveProgress(p);
  document.querySelectorAll('.classify-btn').forEach(btn => { btn.style.pointerEvents = 'none'; });
  const correctConcept = concepts.find(c => c.id === s.answer);
  const fb = document.getElementById('classifierFeedback');
  fb.className = `feedback-box visible ${correct ? 'correct' : 'incorrect'}`;
  fb.innerHTML = `
    <div class="feedback-result ${correct ? 'correct' : 'incorrect'}">${correct ? '\u2713 Correct!' : '\u2717 Incorrect — Answer: ' + (correctConcept ? correctConcept.name : s.answer)}</div>
    <p>${s.explanation}</p>
  `;
  document.getElementById('classifierNext').style.display = 'inline-block';
  document.querySelector('.classifier-score').innerHTML = `Score: <span>${classifierScore}</span> / ${classifierTotal}`;
}

function nextScenario() { classifierIndex++; renderClassifier(); }

// FLASHCARDS
function initFlashcards() { shuffledFlashcards = shuffle(flashcards); flashcardIndex = 0; renderFlashcard(); }

function renderFlashcard() {
  const container = document.getElementById('flashcardContainer');
  if (flashcardIndex >= shuffledFlashcards.length) { flashcardIndex = 0; shuffledFlashcards = shuffle(flashcards); }
  const card = shuffledFlashcards[flashcardIndex];
  container.innerHTML = `
    <div class="flashcard-controls"><div class="flashcard-counter">Card <span>${flashcardIndex + 1}</span> / ${shuffledFlashcards.length}</div></div>
    <div class="flashcard-wrapper">
      <div class="flashcard" id="currentFlashcard" onclick="this.classList.toggle('flipped')">
        <div class="flashcard-face flashcard-front">
          <div class="flashcard-category">${card.category}</div>
          <div class="flashcard-question">${card.q}</div>
          <div class="flashcard-hint">Click to flip</div>
        </div>
        <div class="flashcard-face flashcard-back">
          <div class="flashcard-category">Answer</div>
          <div class="flashcard-answer">${card.a}</div>
        </div>
      </div>
    </div>
    <div class="flashcard-nav">
      <button class="card-nav-btn" onclick="prevFlashcard()">\u2190</button>
      <div class="difficulty-btns">
        <button class="diff-btn hard" onclick="rateFlashcard('hard')">Hard</button>
        <button class="diff-btn good" onclick="rateFlashcard('good')">Good</button>
        <button class="diff-btn easy" onclick="rateFlashcard('easy')">Easy</button>
      </div>
      <button class="card-nav-btn" onclick="nextFlashcard()">\u2192</button>
    </div>
  `;
}

function prevFlashcard() { flashcardIndex = Math.max(0, flashcardIndex - 1); renderFlashcard(); }
function nextFlashcard() { flashcardIndex++; renderFlashcard(); }
function rateFlashcard(d) {
  const p = loadProgress(); p.flashcardsReviewed++;
  if (d === 'easy') p.flashcardsEasy++; if (d === 'hard') p.flashcardsHard++;
  saveProgress(p); nextFlashcard();
}

// QUIZ
function initQuiz() { shuffledQuiz = shuffle(quizQuestions).slice(0, 10); quizIndex = 0; quizScore = 0; quizAnswered = new Array(shuffledQuiz.length).fill(null); renderQuiz(); }

function renderQuiz() {
  const container = document.getElementById('quizContainer');
  if (quizIndex >= shuffledQuiz.length) {
    const p = loadProgress(); p.quizzesTaken++; p.quizCorrect += quizScore; p.quizTotal += shuffledQuiz.length; saveProgress(p);
    const pct = Math.round((quizScore / shuffledQuiz.length) * 100);
    container.innerHTML = `<div class="quiz-results"><h3>Quiz Complete</h3><div class="quiz-score">${pct}%</div><p>You got ${quizScore} / ${shuffledQuiz.length} correct.</p><button class="restart-btn" onclick="initQuiz()">Retake Quiz</button></div>`;
    return;
  }
  const q = shuffledQuiz[quizIndex];
  const letters = ['A', 'B', 'C', 'D'];
  container.innerHTML = `
    <div class="quiz-progress">
      ${shuffledQuiz.map((_, i) => {
        let cls = '';
        if (i === quizIndex) cls = 'current';
        else if (quizAnswered[i] !== null) cls = quizAnswered[i] ? 'correct' : 'incorrect';
        return `<div class="quiz-dot ${cls}"></div>`;
      }).join('')}
    </div>
    <div class="quiz-question-card">
      <div class="quiz-q-num">Question ${quizIndex + 1} of ${shuffledQuiz.length}</div>
      <div class="quiz-q-text">${q.q}</div>
      <div class="quiz-options">
        ${q.options.map((opt, i) => `<div class="quiz-option" onclick="answerQuiz(${i})"><span class="option-letter">${letters[i]}</span><span>${opt}</span></div>`).join('')}
      </div>
    </div>
    <div class="quiz-explanation" id="quizExplanation"><p>${q.explanation}</p></div>
    <div class="classifier-controls" style="margin-top:24px">
      <div></div>
      <button class="next-btn" id="quizNext" style="display:none" onclick="nextQuizQuestion()">
        ${quizIndex < shuffledQuiz.length - 1 ? 'Next Question \u2192' : 'See Results \u2192'}
      </button>
    </div>
  `;
}

function answerQuiz(idx) {
  const q = shuffledQuiz[quizIndex];
  const correct = idx === q.correct;
  if (correct) quizScore++;
  quizAnswered[quizIndex] = correct;
  document.querySelectorAll('.quiz-option').forEach((opt, i) => {
    opt.classList.add('disabled');
    if (i === q.correct) opt.classList.add('correct');
    if (i === idx && !correct) opt.classList.add('incorrect');
  });
  document.getElementById('quizExplanation').classList.add('visible');
  document.getElementById('quizNext').style.display = 'inline-block';
}

function nextQuizQuestion() { quizIndex++; renderQuiz(); }

// PROGRESS
function renderProgress() {
  const container = document.getElementById('progressContent');
  const p = loadProgress();
  const classifierPct = p.classifierTotal > 0 ? Math.round((p.classifierCorrect / p.classifierTotal) * 100) : 0;
  const quizPct = p.quizTotal > 0 ? Math.round((p.quizCorrect / p.quizTotal) * 100) : 0;
  const conceptsPct = Math.round((p.conceptsViewed.length / concepts.length) * 100);
  const totalCh = books.reduce((s, b) => s + b.chapters.length, 0);
  const chaptersPct = Math.round((p.chaptersViewed.length / totalCh) * 100);
  const memPct = p.flashcardsReviewed > 0 ? Math.round((p.flashcardsEasy / p.flashcardsReviewed) * 100) : 0;
  container.innerHTML = `
    <div class="stats-grid">
      <div class="stat-card"><div class="stat-value">${p.conceptsViewed.length}/${concepts.length}</div><div class="stat-label">Concepts Explored</div></div>
      <div class="stat-card"><div class="stat-value">${p.flashcardsReviewed}</div><div class="stat-label">Cards Reviewed</div></div>
      <div class="stat-card"><div class="stat-value">${classifierPct}%</div><div class="stat-label">Classifier Accuracy</div></div>
      <div class="stat-card"><div class="stat-value">${quizPct}%</div><div class="stat-label">Quiz Accuracy</div></div>
    </div>
    <div class="mastery-section">
      <h3>Mastery Analysis</h3>
      <div class="mastery-item"><span class="mastery-label">Concepts</span><div class="mastery-bar-bg"><div class="mastery-bar" style="width:${conceptsPct}%"></div></div><span class="mastery-pct">${conceptsPct}%</span></div>
      <div class="mastery-item"><span class="mastery-label">Chapters</span><div class="mastery-bar-bg"><div class="mastery-bar" style="width:${chaptersPct}%"></div></div><span class="mastery-pct">${chaptersPct}%</span></div>
      <div class="mastery-item"><span class="mastery-label">Classifier</span><div class="mastery-bar-bg"><div class="mastery-bar" style="width:${classifierPct}%"></div></div><span class="mastery-pct">${classifierPct}%</span></div>
      <div class="mastery-item"><span class="mastery-label">Quiz</span><div class="mastery-bar-bg"><div class="mastery-bar" style="width:${quizPct}%"></div></div><span class="mastery-pct">${quizPct}%</span></div>
      <div class="mastery-item"><span class="mastery-label">Memory</span><div class="mastery-bar-bg"><div class="mastery-bar" style="width:${memPct}%"></div></div><span class="mastery-pct">${memPct}%</span></div>
    </div>
    <button class="next-btn" style="margin-top:16px" onclick="if(confirm('Reset all progress?')){localStorage.removeItem(STORAGE_KEY);renderProgress();}">Reset Progress</button>
  `;
}

// NAV
let lastScroll = 0;
window.addEventListener('scroll', () => {
  const nav = document.getElementById('mainNav');
  const st = window.scrollY;
  if (st > lastScroll && st > 100) nav.classList.add('hidden');
  else nav.classList.remove('hidden');
  lastScroll = st;
});

document.addEventListener('keydown', e => {
  if (currentSection === 'flashcards') {
    if (e.code === 'Space') { e.preventDefault(); const fc = document.getElementById('currentFlashcard'); if (fc) fc.classList.toggle('flipped'); }
    if (e.code === 'ArrowRight') nextFlashcard();
    if (e.code === 'ArrowLeft') prevFlashcard();
  }
  if (e.key === 'Escape') closeModal();
});

updateProgressBar();
</script>
</body>
</html>